<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <style type="text/css">
        /* 上传附件 */
        .layui-upload-drag {
            margin-top: 10px;
            padding-bottom: 0;
        }
        .upload-btn {
            margin-top: 20px;
        }
        .tip {
            width: 85%;
            color: #999;
            font-size: 10px;
            padding-top: 10px;
        }

        .input-title{
            font-weight: bold;
        }
        .not-input{
            color: #999999;
        }
    </style>
</head>
<body>
    <blockquote class="layui-elem-quote layui-text">
       注意：只有会议发起人才能对会议部分信息进行修改！
    </blockquote>

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>编辑会议纪要(#<span id="minute-id"></span>)</legend>
    </fieldset>

    <div class="layui-form layuimini-form">
        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">组织部门</label>
            <div class="layui-input-inline">
                <input type="text" name=""  id="department-name" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
            <label class="layui-form-label input-title not-input" >会议主持</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="minute-host" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">会议主题</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="minute-theme" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
            <label class="layui-form-label input-title not-input">会议地点</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="minute-place" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">项目代号</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="project-code" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
            <label class="layui-form-label input-title not-input">项目阶段</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="project-stage" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">会议时间</label>
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input type="text" id="date"  class="layui-input" disabled="disabled"/>
                </div>
                <div class="layui-input-inline">
                    <input type="text" id="time" class="layui-input" disabled="disabled"/>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">完成情况</label>
            <div class="layui-input-block">
                <input type="text" name="title" id="complete-status" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">应到人员</label>
            <div class="layui-input-block">
                <input type="text" name="title" id="attend-user" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title">实到人员</label>
            <div class="layui-input-block">
                <input type="text" name="" placeholder="--请选择已到会人员--" autocomplete="off" class="layui-input" id="attended-user" value="" ts-selected="">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title">新增应到人员</label>
            <div class="layui-input-block">
                <input type="text" name="" placeholder="--请选择新增应到员工--" autocomplete="off" class="layui-input" id="new-attend-users" value="" ts-selected="">
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">新增基本任务清单</label>
            <div class="layui-input-block">
                <input type="text" name="" placeholder="--请选择基本任务清单--" autocomplete="off" class="layui-input" id="add-mission" value="" ts-selected="">
            </div>
        </div>

        <!--<div class="layui-form-item layui-form-text">-->
            <!--<label class="layui-form-label input-title">新增复合任务清单</label>-->
            <!--<div class="layui-input-block">-->
                <!--<input type="text" name="" placeholder="&#45;&#45;请选择复合任务清单&#45;&#45;" autocomplete="off" class="layui-input" id="add-minute-mission" value="" ts-selected="">-->
            <!--</div>-->
        <!--</div>-->

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">会议决议</label>
            <div class="layui-input-block">
                <textarea placeholder="请输入内容" name="minute-resolution" id="minute-resolution" class="layui-textarea"></textarea>
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">会议记录</label>
            <div class="layui-input-block">
                <textarea placeholder="请输入内容" name="minute-context" id="minute-context" class="layui-textarea"></textarea>
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title not-input">会议纪要任务表</label>
            <div class="layui-input-block">
                <table class="layui-hide" id="minute-table"></table>
            </div>
        </div>

        <div class="layui-form-item layui-form-text" id="missionTable">
            <label class="layui-form-label input-title">添加会议纪要任务</label>
            <div class="layui-input-block">
                <!--<table class="layui-hide" id="addMinuteResolution" lay-filter="addTableFilter"></table>-->
                <table class="layui-table" lay-skin="line" id="addMissionTable">
                    <tr>
                        <th>标题</th>
                        <th>责任部门</th>
                        <th>责任人</th>
                        <th>完成日期</th>
                        <th>任务描述</th>
                        <th><button type="button" class="layui-btn" id="addEvent">添加</button></th>
                    </tr>
                </table>
            </div>
        </div>

        <script type="text/html" id="currentTableBar">
            <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="delete">删除</a>
        </script>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">上传附件</label>
            <div class="layui-form-item">
                <div class="layui-fluid">
                    <div class="layui-row">
                        <div class="layui-col-sm3 layui-col-sm-offset1">
                            <div class="layui-upload-drag" id="attachment">
                                <i class="layui-icon"></i>
                                <p>点击上传，或将文件拖拽到此处</p>
                                <input type="hidden" id="attachment_list" name="attachment_list">
                                <button type="button" class="layui-btn upload-btn" id="start_upload" onclick="stopPropagation()" style="margin-top: 20px">开始上传</button>
                            </div>
                            <div class="tip">提示：1.选择文件后请先点击“开始上传”按钮再提交；2.最多上传10个文件</div>
                        </div>
                        <div class="layui-col-sm8">
                            <div class="layui-upload-list">
                                <table class="layui-table">
                                    <thead>
                                    <tr><th>文件名</th>
                                        <th>大小</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr></thead>
                                    <tbody id="fileList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-container">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-md4"></div>
                    <div class="layui-col-md4">
                        <button class="layui-btn" id="save" lay-submit lay-filter="save">立即提交</button>
                        <button type="reset" id="refresh" class="layui-btn layui-btn-primary">重置</button>
                        <button class="layui-btn" id="temporarySave">临时保存</button>
                    </div>
                    <div class="layui-col-md4"></div>
                </div>
            </div>
        </div>

    </div>
<script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script type="text/javascript" src="../../js/lay-module/tableSelect/tableSelect.js"></script>
<script type="text/javascript" src="../../js/meet/update-minute.js"></script>
<script>
    // layui.use(['form', 'layedit', 'laydate' ,'upload','table'], function () {
    //     var   form    = layui.form
    //         , layer   = layui.layer
    //         , layedit = layui.layedit
    //         , laydate = layui.laydate
    //         , upload  = layui.upload
    //         , table   = layui.table
    //         , tableSelect = layui.tableSelect;
    //
    //     laydate.render({
    //         elem: '#dateTime'
    //     });
    //
    //     /**
    //      * 选择已到会员工
    //      */
    //     tableSelect.render({
    //         elem: '#attended-user',	//定义输入框input对象 必填
    //         checkedKey: 'user_id', //表格的唯一建值，非常重要，影响到选中状态 必填
    //         searchKey: 'keyword',	//搜索输入框的name值 默认keyword
    //         searchList: [
    //             {searchKey: 'keyword', searchPlaceholder: '员工名字/部门'},  //搜索条件1
    //         ],
    //         table: {	//定义表格参数，与LAYUI的TABLE模块一致，只是无需再定义表格elem
    //             url:'/office_automation/public/index.php/index/minute_c/getAllUsers?type=1&minuteId='+minute_id,
    //             cols: [[
    //                 {type: "checkbox"},
    //                 {field: 'user_id', title: '员工工号'},
    //                 {field: 'user_name', title: '姓名'},
    //                 {field: 'department_name', title: '部门'},
    //             ]]
    //         },
    //         done: function (elem, data) {
    //             var NEWJSON = []
    //             layui.each(data.data, function (index, item) {
    //                 NEWJSON.push(item.user_name);
    //                 attended.push(item.user_id);
    //             })
    //             elem.val(NEWJSON.join(","))
    //         }
    //     });
    //
    //     /**
    //      * 选择新添需要到会员工
    //      */
    //     tableSelect.render({
    //         elem: '#new-attend-users',
    //         checkedKey: 'user_id',
    //         searchKey: 'keyword',
    //         searchList: [
    //             {searchKey: 'keyword', searchPlaceholder: '员工名字/部门'},
    //         ],
    //         table: {
    //             url:'/office_automation/public/index.php/index/minute_c/getAllUsers?type=2&minuteId='+minute_id,
    //             cols: [[
    //                 {type : "checkbox"},
    //                 {field: 'user_id', title: '员工工号'},
    //                 {field: 'user_name', title: '姓名'},
    //                 {field: 'department_name', title: '部门'},
    //             ]]
    //         },
    //         done: function (elem, data) {
    //             var NEWJSON = [];
    //             layui.each(data.data, function (index, item) {
    //                 NEWJSON.push(item.user_name);
    //                 newAttended.push(item.user_id);
    //             })
    //             elem.val(NEWJSON.join(","))
    //         }
    //     });
    //
    //     /**
    //      * 选择基本任务清单
    //      */
    //     tableSelect.render({
    //         elem: '#add-mission',
    //         checkedKey: 'mission_id',
    //         searchKey: 'keyword',
    //         searchList: [
    //             {searchKey: 'keyword', searchPlaceholder: '任务标题/任务ID'},  //搜索条件
    //         ],
    //         table: {
    //             url:'/office_automation/public/index/mission_c/selectIndex?type=1',
    //             cols: [[
    //                 {type: "checkbox"},
    //                 {field: 'mission_id', title: '任务号'},
    //                 {field: 'mission_title', title: '任务标题'},
    //                 {field: 'assignee_name', title: '负责人'},
    //             ]]
    //         },
    //         done: function (elem, data) {
    //             var NEWJSON = [];
    //             layui.each(data.data, function (index, item) {
    //                 NEWJSON.push(item.mission_id);
    //             });
    //             newMission = NEWJSON;
    //             elem.val(NEWJSON.join(","))
    //         }
    //     });
    //
    //     //文件上传
    //     var fileListView = $('#fileList')
    //         ,uploadListIns = upload.render({
    //         elem: '#attachment'
    //         ,url: '/office_automation/public/attachment'
    //         ,auto: false
    //         ,multiple: true
    //         ,number: 3          // 同时可上传的文件数量
    //         ,size: 20480            // 单位 KB，最大 20MB
    //         ,accept: 'file'
    //         ,bindAction: '#start_upload'
    //         ,choose: function(obj){
    //             if($('#fileList').children().length > 2) {
    //                 return layer.msg('最多上传三个附件！');
    //             }
    //             var files = this.files = obj.pushFile();         // 将每次选择的文件追加到文件队列
    //             $("#start_upload").removeAttr("disabled");
    //             // 预读本地文件
    //             obj.preview(function(index, file, result){          // 分别是文件索引、文件对象、文件base64编码
    //                 var tr = $(['<tr id="upload-'+ index +'">'
    //                     ,'<td>'+ file.name +'</td>'
    //                     ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
    //                     ,'<td>等待上传</td>'
    //                     ,'<td>'
    //                     ,'<button class="layui-btn layui-btn-xs layui-hide reload">重传</button>'
    //                     ,'<button class="layui-btn layui-btn-xs layui-btn-danger delete">删除</button>'
    //                     ,'</td>'
    //                     ,'</tr>'].join(''));
    //
    //                 //单个重传
    //                 tr.find('.reload').on('click', function(){
    //                     obj.upload(index, file);
    //                 });
    //
    //                 //删除
    //                 tr.find('.delete').on('click', function(){
    //                     delete files[index];            // 删除对应的文件
    //                     tr.remove();
    //                     uploadListIns.config.elem.next()[0].value = '';         // 清空 input file 值，以免删除后出现同名文件不可选
    //                     if(!files) {
    //                         $("#start_upload").attr("disabled", true);
    //                     }
    //                 });
    //
    //                 fileListView.append(tr);
    //             });
    //         }
    //         ,before: function(obj){
    //             layer.load();            // 取消上传后仍会触发 before
    //         }
    //         ,done: function(res, index, upload){
    //             if(res.code == 0){
    //                 uploadList.push(res.data.id);
    //                 var tr = fileListView.find('tr#upload-'+ index)
    //                     ,tds = tr.children();
    //                 tds.eq(3).html('<span style="color: #5FB878;">上传成功</span>');
    //                 tds.eq(4).html('');
    //                 delete this.files[index];            // 删除文件队列已经上传成功的文件
    //             } else {
    //                 console.log('上传失败：' + res.msg + `(${index})`);
    //                 this.error(index, upload);
    //             }
    //         }
    //         ,allDone: function(obj){
    //             layer.closeAll('loading');
    //             layer.msg('上传完成！');
    //             $("#start_upload").attr("disabled", true);
    //             console.log('上传完成！共上传' + obj.total + '个文件，成功文件数：' + obj.successful +'，失败文件数：' + obj.aborted);
    //         }
    //         ,error: function(index, upload){            // 分别为当前文件的索引、重新上传的方法
    //             var tr = fileListView.find('tr#upload-'+ index)
    //                 ,tds = tr.children();
    //             tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
    //             tds.eq(3).find('.reload').removeClass('layui-hide');           // 显示重传
    //         }
    //     });
    //
    //     //自定义验证规则
    //     form.verify({
    //         title: function (value) {
    //             if (value.length < 5) {
    //                 return '标题至少得5个字符啊';
    //             }
    //         }
    //         , pass: [
    //             /^[\S]{6,12}$/
    //             , '密码必须6到12位，且不能出现空格'
    //         ]
    //         , content: function (value) {
    //             layedit.sync(editIndex);
    //         }
    //     });
    //
    //     //展示会议纪要任务表已有数据
    //     table.render({
    //         elem: '#minute-table'
    //         ,cols: [[ //标题栏
    //              {field: 'mission_id', title: 'ID', width: 200}
    //             ,{field: 'mission_title', title: '标题', width: 200}
    //             ,{field: 'assignee_name', title: '责任人', Width: 200}
    //             ,{field: 'finish_date',title: '完成日期', Width: 200}
    //             ,{field: 'process_note', title: '最近处理信息', width: 200}
    //             ,{field: 'status', title: '进度', width: 200}
    //         ]]
    //         ,data: []
    //         ,even: true
    //     });
    //
    //     /**
    //      * 添加一条会议任务
    //      */
    //     $("#addEvent").on("click",function () {
    //         var $missionInfo = "<tr class='missionItem'>\n" +
    //             "                        <td><input type=\"text\" name=\"title\" lay-verify=\"required\" placeholder=\"请输入标题\" autocomplete=\"off\" class=\"layui-input title\"></td>\n" +
    //             "                        <td>\n" +
    //             "                            <select class=\"departmentSelect\" name=\"departmentSelect\" lay-verify=\"required\" lay-filter=\"departmentSelect\">\n" +
    //             "                                <option value=\"\">--选择部门--</option>\n" +
    //                                                 departmentInfo +
    //             "                            </select>\n" +
    //             "                        </td>\n" +
    //             "                        <td>\n" +
    //             "                            <select class=\"userSelect responsible\" name=\"userSelect\" lay-verify=\"required\" lay-filter=\"userSelect\">\n" +
    //             "                                <option value=\"\">--请先选择部门--</option>\n" +
    //             "                            </select>\n" +
    //             "                        </td>\n" +
    //             "                        <td><input type=\"date\" name=\"dateTime\" autocomplete=\"off\" lay-verify=\"required\" class=\"layui-input finish-date\"></td>\n" +
    //             "                        <td><input type=\"text\" name=\"title\" placeholder=\"请输入任务描述\" autocomplete=\"off\" lay-verify=\"required\" class=\"layui-input describe\"></td>\n" +
    //             "                        <td> <a class=\"layui-btn layui-btn-xs layui-btn-danger data-count-delete deleteMission\">删除</a></td>\n" +
    //             "                    </tr>";
    //         $("#addMissionTable").append($missionInfo);
    //         form.render();
    //     });
    //
    //     /**
    //      * 监听会议类型查询
    //      */
    //     form.on('select(departmentSelect)',function(data){
    //         var department_id = data.value;
    //         var $userSelect = $(this).parent().parent().parent().next().children("select");
    //         $.ajax({
    //             url: "/office_automation/public/index.php/index/user_c/getUserByDepartment",
    //             type:'get',
    //             timeout: 1000,
    //             data: {
    //                 departmentId : department_id,
    //             },
    //             success: function(res){
    //                 var userArray = res.data;
    //                 var userOptions = "";
    //                 $userSelect.empty();//先清空子节点
    //                 if(userArray == null){
    //                     userOptions = "<option value=''>" + "--请先选择部门--" + "</option>";
    //                     $userSelect.append(userOptions);
    //                     form.render();
    //                     return;
    //                 }
    //                 userOptions += "<option value=''>" + "--选择负责人--" + "</option>";
    //                 for (var i = 0; i < userArray.length; i++){
    //                    userOptions += "<option value='" + userArray[i]["user_id"] + "'>" + userArray[i]["user_name"] + "</option>";
    //                 }
    //                 $userSelect.append(userOptions);
    //                 form.render();
    //             },
    //             error: function(data){
    //             }
    //         });
    //         return false;
    //     });
    //
    //     /**
    //      * 删除某一条会议任务
    //      */
    //     $("#addMissionTable tbody").on("click",".deleteMission", function() {
    //         $(this).parent().parent().remove();
    //     });
    //
    //     //监听提交
    //     form.on('submit(save)', function (data) {
    //         var minuteResolution  = $("#minute-resolution").val();
    //         var minuteContext     = $("#minute-context").val();
    //         var minuteMission     = getMissionInfo();
    //         $.ajax({
    //             url: "/office_automation/public/index.php/index/minute_c/updateMinute",
    //             type:'post',
    //             timeout: 2000,
    //             data: {
    //                 minuteId        : minute_id,
    //                 attendList      : attended,         //已到会人员（数组）
    //                 newAttended     : newAttended,      //新增应到会人
    //                 newMission      : newMission,       //关联新任务
    //                 minuteResolution: minuteResolution, //会议决议
    //                 minuteContext   : minuteContext,    //会议记录
    //                 minuteMission   : minuteMission,    //新会议任务（数组）
    //                 uploadList      : uploadList        //附件（数组）
    //             },
    //             success: function(res){
    //                 layer.alert('会议修改成功！', {title: '提示'},
    //                     function (index) {
    //                         layer.close(index);
    //                         location.reload();
    //                     }
    //                 );
    //             },
    //             error: function(data){
    //             }
    //         });
    //         return false;
    //     });
    //
    //     //重置
    //     $("#refresh").on("click",function(){
    //         location.reload();
    //     });
    //
    // });
</script>

</body>
</html>