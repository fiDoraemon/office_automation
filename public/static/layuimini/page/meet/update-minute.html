<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <style type="text/css">
        .input-title{
            font-weight: bold;
        }
        .not-input{
            color: #999999;
        }
        .move-btn {
            position: absolute;
            top: 126px;
            right: 132px;
        }
        .layui-upload-drag {
            padding: 40px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <blockquote class="layui-elem-quote layui-text">
       注意：只有会议发起人才能对会议部分信息进行修改！
    </blockquote>

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>会议详细信息</legend>
    </fieldset>

    <div class="layui-form layuimini-form">
        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">组织部门</label>
            <div class="layui-input-inline">
                <input type="text" name="" lay-verify="" id="department-name" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
            <label class="layui-form-label input-title not-input" >会议主持</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="minute-host" lay-verify="title" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">会议主题</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="minute-theme" lay-verify="title" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
            <label class="layui-form-label input-title not-input">会议地点</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="minute-place" lay-verify="title" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">项目代号</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="project-code" lay-verify="title" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
            <label class="layui-form-label input-title not-input">项目阶段</label>
            <div class="layui-input-inline">
                <input type="text" name="title" id="project-stage" lay-verify="title" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>


        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">会议时间</label>
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input type="text" id="date"  class="layui-input" disabled="disabled"/>
                </div>
                <div class="layui-input-inline">
                    <input type="text" id="time" class="layui-input" disabled="disabled"/>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">完成情况</label>
            <div class="layui-input-block">
                <input type="text" name="title" id="complete-status" lay-verify="title" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title not-input">应到人员</label>
            <div class="layui-input-block">
                <input type="text" name="title" id="attend-user" lay-verify="title" autocomplete="off" placeholder="" class="layui-input" disabled="disabled">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title">实到人员</label>
            <div class="layui-input-block">
                <input type="text" name="" placeholder="--请选择已到会人员--" autocomplete="off" class="layui-input" id="attended-user" value="" ts-selected="">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label input-title">新增应到人员</label>
            <div class="layui-input-block">
                <input type="text" name="" placeholder="--请选择新增应到员工--" autocomplete="off" class="layui-input" id="new-attend-users" value="" ts-selected="">
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">新增基本任务清单</label>
            <div class="layui-input-block">
                <input type="text" name="" placeholder="--请选择基本任务清单--" autocomplete="off" class="layui-input" id="add-mission" value="" ts-selected="">
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">新增复合任务清单</label>
            <div class="layui-input-block">
                <input type="text" name="" placeholder="--请选择复合任务清单--" autocomplete="off" class="layui-input" id="add-minute-mission" value="" ts-selected="">
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">会议决议</label>
            <div class="layui-input-block">
                <textarea placeholder="请输入内容" id="minute-resolution" class="layui-textarea"></textarea>
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">会议记录</label>
            <div class="layui-input-block">
                <textarea placeholder="请输入内容" id="minute-context" class="layui-textarea"></textarea>
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title not-input">会议纪要任务表</label>
            <div class="layui-input-block">
                <table class="layui-hide" id="minute-table"></table>
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">添加会议纪要任务表</label>
            <div class="layui-input-block">
                <!--<table class="layui-hide" id="addMinuteResolution" lay-filter="addTableFilter"></table>-->
                <div class="layui-form">
                    <table class="layui-table">
                        <thead>
                        <tr>
                            <th>标题</th>
                            <th>责任部门</th>
                            <th>责任人</th>
                            <th>完成日期</th>
                            <th>任务描述</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="date" id="date1" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input date"></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete">删除</a></td>
                        </tr>
                        <tr>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="" id="date2" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="" class="layui-input date"></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete">删除</a></td>
                        </tr>
                        <tr>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><input type="text" name="" id="date3" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="" class="layui-input date"></td>
                            <td><input type="text" name="" lay-verify="" autocomplete="off" placeholder="" class="layui-input"/></td>
                            <td><a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete">删除</a></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" class="layui-btn layui-btn-primary layui-btn-fluid" id="addEvent">添加会议纪要任务</button>
            </div>
        </div>

        <script type="text/html" id="currentTableBar">
            <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="delete">删除</a>
        </script>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label input-title">上传附件</label>
            <div class="layui-form-item">
                <div class="layui-fluid">
                    <div class="layui-row">
                        <div class="layui-col-sm3 layui-col-sm-offset1">
                            <div class="layui-upload-drag" id="attachment">
                                <i class="layui-icon"></i>
                                <p>点击上传，或将文件拖拽到此处</p>
                                <input type="hidden" id="attachment_list" name="attachment_list">
                            </div>
                            <button type="button" class="layui-btn move-btn" id="start_upload">开始上传</button>
                        </div>
                        <div class="layui-col-sm8">
                            <div class="layui-upload-list">
                                <table class="layui-table">
                                    <thead>
                                    <tr><th>文件名</th>
                                        <th>大小</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr></thead>
                                    <tbody id="fileList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-container">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-md4"></div>
                    <div class="layui-col-md4">
                        <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        <button class="layui-btn" lay-submit="" lay-filter="demo1">临时保存</button>
                    </div>
                    <div class="layui-col-md4"></div>
                </div>
            </div>
        </div>

    </div>

<script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="../../lib/layui-v2.5.5/layui.all.js"></script>
<script type="text/javascript" src="../../js/meet/update-minute.js"></script>
<script type="text/javascript" src="../../js/lay-module/tableSelect/tableSelect.js"></script>
<script>
    //开始使用下拉多个选择
    var tableSelect = layui.tableSelect;

    /**
     * 选择已到会员工
     */
    tableSelect.render({
        elem: '#attended-user',	//定义输入框input对象 必填
        checkedKey: 'user_id', //表格的唯一建值，非常重要，影响到选中状态 必填
        searchKey: 'keyword',	//搜索输入框的name值 默认keyword
        // searchPlaceholder: '员工搜索',	//搜索输入框的提示文字 默认关键词搜索
        height:'500',  //自定义高度
        width:'500',  //自定义宽度
        // searchType: 'more', //开启多条件搜索
        searchList: [
            {searchKey: 'keyword', searchPlaceholder: '员工名字/部门'},  //搜索条件1
        ],
        table: {	//定义表格参数，与LAYUI的TABLE模块一致，只是无需再定义表格elem
            url:'/office_automation/public/index.php/index/minute_c/getAllUsers?type=1&minuteId='+minute_id,
            cols: [[
                {type: "checkbox", width: 80},
                {field: 'user_id', width: 140, title: '员工工号'},
                {field: 'user_name', width: 140, title: '姓名'},
                {field: 'department_name', width: 140, title: '部门'},
            ]]
        },
        done: function (elem, data) {
            var NEWJSON = []
            console.log(data.data);
            layui.each(data.data, function (index, item) {
                NEWJSON.push(item.user_name)
            })
            elem.val(NEWJSON.join(","))
        }
    });

    /**
     * 选择新添需要到会员工
     */
    tableSelect.render({
        elem: '#new-attend-users',	//定义输入框input对象 必填
        checkedKey: 'user_id', //表格的唯一建值，非常重要，影响到选中状态 必填
        searchKey: 'keyword',	//搜索输入框的name值 默认keyword
        // searchPlaceholder: '员工搜索',	//搜索输入框的提示文字 默认关键词搜索
        height:'500',  //自定义高度
        width:'500',  //自定义宽度
        // searchType: 'more', //开启多条件搜索
        searchList: [
            {searchKey: 'keyword', searchPlaceholder: '员工名字/部门'},  //搜索条件1
        ],
        table: {	//定义表格参数，与LAYUI的TABLE模块一致，只是无需再定义表格elem
            url:'/office_automation/public/index.php/index/minute_c/getAllUsers?type=2&minuteId='+minute_id,
            cols: [[
                {type: "checkbox", width: 80},
                {field: 'user_id', width: 140, title: '员工工号'},
                {field: 'user_name', width: 140, title: '姓名'},
                {field: 'department_name', width: 140, title: '部门'},
            ]]
        },
        done: function (elem, data) {
            var NEWJSON = []
            console.log(data.data);
            layui.each(data.data, function (index, item) {
                NEWJSON.push(item.user_name)
            })
            elem.val(NEWJSON.join(","))
        }
    });

    /**
     * 选择基本任务清单
     */
    tableSelect.render({
        elem: '#add-mission',	    //定义输入框input对象 必填
        checkedKey: 'mission_id',   //表格的唯一建值，非常重要，影响到选中状态 必填
        searchKey: 'keyword',	    //搜索输入框的name值 默认keyword
        height:'500',
        width:'500',
        searchList: [
            {searchKey: 'keyword', searchPlaceholder: '任务名字/任务ID'},  //搜索条件
        ],
        table: {
            url:'/office_automation/public/index.php/index/minute_c/getMinuteMission',
            cols: [[
                {type: "checkbox", width: 80},
                {field: 'mission_id', width: 140, title: '任务号'},
                {field: 'mission_name', width: 140, title: '任务标题'},
                {field: 'assignee_name', width: 140, title: '负责人'},
            ]]
        },
        done: function (elem, data) {
            var NEWJSON = [];
            console.log(data.data);
            layui.each(data.data, function (index, item) {
                NEWJSON.push(item.user_name)
            })
            elem.val(NEWJSON.join(","))
        }
    });

    /**
     * 选选择复合任务清单
     */
    tableSelect.render({
        elem: '#add-minute-mission',	    //定义输入框input对象 必填
        checkedKey: 'mission_id',   //表格的唯一建值，非常重要，影响到选中状态 必填
        searchKey: 'keyword',	    //搜索输入框的name值 默认keyword
        height:'500',
        width:'500',
        searchList: [
            {searchKey: 'keyword', searchPlaceholder: '任务名字/任务ID'},  //搜索条件
        ],
        table: {
            url:'/office_automation/public/index.php/index/minute_c/getMinuteMission',
            cols: [[
                {type: "checkbox", width: 80},
                {field: 'mission_id', width: 140, title: '任务号'},
                {field: 'mission_name', width: 140, title: '任务标题'},
                {field: 'assignee_name', width: 140, title: '负责人'},
            ]]
        },
        done: function (elem, data) {
            var NEWJSON = [];
            console.log(data.data);
            layui.each(data.data, function (index, item) {
                NEWJSON.push(item.user_name)
            })
            elem.val(NEWJSON.join(","))
        }
    });

    layui.use(['form', 'layedit', 'laydate' ,'upload','table'], function () {
        var form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate
            , upload = layui.upload
            , table = layui.table;

        //日期
        laydate.render({
            elem: '.date'
        });


        //文件上传
        var fileListView = $('#fileList')
            ,uploadListIns = upload.render({
            elem: '#attachment'
            ,url: '/office_automation/public/attachment'
            ,auto: false
            ,multiple: true
            ,number: 3          // 同时可上传的文件数量
            ,size: 20480            // 单位 KB，最大 20MB
            ,accept: 'file'
            ,bindAction: '#start_upload'
            ,choose: function(obj){
                if($('#fileList').children().length > 2) {
                    return layer.msg('最多上传三个附件！');
                }
                var files = this.files = obj.pushFile();         // 将每次选择的文件追加到文件队列
                $("#start_upload").removeAttr("disabled");
                // 预读本地文件
                obj.preview(function(index, file, result){          // 分别是文件索引、文件对象、文件base64编码
                    var tr = $(['<tr id="upload-'+ index +'">'
                        ,'<td>'+ file.name +'</td>'
                        ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
                        ,'<td>等待上传</td>'
                        ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs layui-hide reload">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger delete">删除</button>'
                        ,'</td>'
                        ,'</tr>'].join(''));

                    //单个重传
                    tr.find('.reload').on('click', function(){
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.delete').on('click', function(){
                        delete files[index]; //删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = '';         // 清空 input file 值，以免删除后出现同名文件不可选
                        if(!files) {
                            $("#start_upload").attr("disabled", true);
                        }
                    });

                    fileListView.append(tr);
                });
            }
            ,before: function(obj){
                layer.load();            // 取消上传后仍会触发 before
            }
            ,done: function(res, index, upload){
                if(res.code == 0){
                    // 写入附件 id
                    if($('#attachment_list').val() == '') {
                        $('#attachment_list').val(res.data.id);
                    } else {
                        var ids = $('#attachment_list').val().split(';');
                        if(!ids.includes(res.data.id)) {
                            ids.push(res.data.id);
                        }
                        $('#attachment_list').val(ids.join(';'));
                    }

                    var tr = fileListView.find('tr#upload-'+ index)
                        ,tds = tr.children();
                    tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                    tds.eq(3).html('');
                    delete this.files[index];            // 删除文件队列已经上传成功的文件
                } else {
                    console.log('上传失败：' + res.msg + `(${index})`);
                    this.error(index, upload);
                }
            }
            ,allDone: function(obj){
                layer.closeAll('loading');
                layer.msg('上传完成！');
                $("#start_upload").attr("disabled", true);
                console.log('上传完成！共上传' + obj.total + '个文件，成功文件数：' + obj.successful +'，失败文件数：' + obj.aborted);
            }
            ,error: function(index, upload){            // 分别为当前文件的索引、重新上传的方法
                var tr = fileListView.find('tr#upload-'+ index)
                    ,tds = tr.children();
                tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                tds.eq(3).find('.reload').removeClass('layui-hide');           // 显示重传
            }
        });

        //自定义验证规则
        form.verify({
            title: function (value) {
                if (value.length < 5) {
                    return '标题至少得5个字符啊';
                }
            }
            , pass: [
                /^[\S]{6,12}$/
                , '密码必须6到12位，且不能出现空格'
            ]
            , content: function (value) {
                layedit.sync(editIndex);
            }
        });

        //监听指定开关
        form.on('switch(switchTest)', function (data) {
            layer.msg('开关checked：' + (this.checked ? 'true' : 'false'), {
                offset: '6px'
            });
            layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
        });

        //监听提交
        form.on('submit(demo1)', function (data) {
            layer.alert(JSON.stringify(data.field), {
                title: '最终的提交信息'
            })
            return false;
        });


        //展示会议纪要任务表已有数据
        table.render({
            elem: '#minute-table'
            ,cols: [[ //标题栏
                {field: 'mission_id', title: 'ID', width: 200}
                ,{field: 'mission_title', title: '标题', width: 200}
                ,{field: 'assignee_name', title: '责任人', Width: 200}
                ,{field: 'finish_date',title: '完成日期', Width: 200}
                ,{field: 'process_note', title: '最近处理信息', width: 200}
                ,{field: 'status', title: '进度', width: 200}
            ]]
            ,data: []
            ,even: true
        });

        //添加决议相关任务
        table.render({
            elem: '#addMinuteResolution',
            // toolbar: '#toolbarTop',
            defaultToolbar: ['filter', 'exports', 'print', {
                title: '提示',
                layEvent: 'LAYTABLE_TIPS',
                icon: 'layui-icon-tips'
            }],
            cols: [[
                 {field: 'id', title: '标题',edit: 'text'}
                ,{field: 'username', title: '责任部门', edit: 'text'}
                ,{field: 'email', title: '责任人', edit: 'text'}
                ,{field: 'sign', title: '完成日期', edit: 'time'}
                ,{field: 'sex', title: '任务描述', edit: 'text'}
                ,{title: '操作',  toolbar: '#currentTableBar', align: "center"}
            ]],
            data: [{
            "id": ""
            ,"username": ""
            ,"email": ""
            ,"sex": ""
            ,"city": ""
            ,"sign": ""
            ,"experience": ""
            ,"ip": ""
            ,"logins": ""
            ,"joinTime": ""
        }]
            ,even: true
        });

        /**
         * 监听添加会议决议事件
         */
        $("#addEvent").on("click",function () {
            var tabledata = table.cache["addMinuteResolution"]; //获取现有数据
            tabledata.push({
                "id": ""
                ,"username": ""
                ,"email": ""
                ,"sex": ""
                ,"city": ""
                ,"sign": ""
                ,"experience": ""
                ,"ip": ""
                ,"logins": ""
                ,"joinTime": ""
            });//添加数据,  字段名对应值.  不要初始值的话 留空即可.
            //下面表格需要重载一下 才会刷新显示.
            table.reload("addMinuteResolution", {
                data: tabledata,
            });
            console.log(table.cache);
        });

        /**
         * 删除某一行监听数据
         */
        table.on('tool(addTableFilter)', function (obj) {
            var data = obj.data;
            console.log(table.cache);
            if (obj.event === 'delete') {
                layer.confirm('真的删除行么', function (index) {
                    obj.del();
                    layer.close(index);
                });
            }
        });


    });
</script>

</body>
</html>