<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>评审文档</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <style>
        .layui-form-item .layui-input-company {
            width: auto;padding-right: 10px;line-height: 38px;
        }

        /* 上传附件 */
        .layui-upload-drag {
            margin-top: 10px;
            padding-bottom: 0;
        }
        .upload-btn {
            margin-top: 20px;
        }
        .tip {
            width: 85%;
            color: #999;
            font-size: 10px;
            padding-top: 10px;
        }
        .input-title{
            font-weight: bold;
        }
        .not-input{
            color: #999999;
        }
    </style>

</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main ">
        <form class="layui-form layuimini-form" lay-filter="setValue">
            <fieldset class="layui-elem-field layui-field-title">
                <legend>申请详情 - <span id="requestId"></span></legend>
            </fieldset>

            <div class="layui-form-item">
                <label class="layui-form-label">所属项目</label>
                <div class="layui-input-inline">
                    <input type="text" id="projectCode" name="project_code" lay-verify="" autocomplete="off" class="layui-input" disabled="disabled">
                </div>
                <label class="layui-form-label">项目阶段</label>
                <div class="layui-input-inline">
                    <input type="text" id="projectStage" name="project_stage" lay-verify="" autocomplete="off" class="layui-input" disabled="disabled">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">申请人</label>
                <div class="layui-input-inline">
                    <input type="text" id="author" name="" lay-verify="" autocomplete="off" class="layui-input" disabled="disabled">
                </div>
                <label class="layui-form-label">申请时间</label>
                <div class="layui-input-inline">
                    <input type="text" id="request_date" name="" lay-verify="" autocomplete="off" class="layui-input" disabled="disabled">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">文档说明</label>
                <div class="layui-input-block">
                    <textarea name="remark" id="remark" class="layui-textarea" rows="5" disabled="disabled"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">归档文件</label>
                <div class="layui-input-block">
                    <table class="layui-table">
                        <thead>
                        <tr><th>文件名</th>
                            <th>大小</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr></thead>
                        <tbody id="fileList"></tbody>
                    </table>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title">
                <legend>评审</legend>
            </fieldset>

            <div class="layui-form-item">
                <label class="layui-form-label required input-title" id="opinion">评审意见</label>
                <div class="layui-input-block">
                    <textarea lay-verify="required" placeholder="请输入意见" name="review_opinion" id="reviewOpinion" class="layui-textarea" rows="5"></textarea>
                </div>
            </div>

            <div class="layui-form-item" id="reviewDate-item">
                <label class="layui-form-label input-title">审批人</label>
                <div class="layui-input-inline">
                    <input type="text" id="approver" name="approver" lay-verify="" autocomplete="off" class="layui-input" disabled="disabled">
                </div>
                <label class="layui-form-label input-title" >评审时间</label>
                <div class="layui-input-inline">
                    <input type="text" id="reviewDate" name="" lay-verify="" autocomplete="off" class="layui-input" disabled="disabled">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label input-title" >评审状态</label>
                <div class="layui-input-block" id="status">
                </div>
            </div>

            <div class="layui-form-item" id="form-item">
                <div class="layui-container" id="form-btn">
                    <div class="layui-row layui-col-space10">
                        <div class="layui-col-md4"></div>
                        <div class="layui-col-md4">
                            <button class="layui-btn" lay-submit lay-filter="passBtn">评审通过</button>
                            <button class="layui-btn layui-btn-danger" lay-submit lay-filter="noPassBtn">驳回申请</button>
                            <button class="layui-btn layui-btn-primary" type="button" id="back">返回</button>
                        </div>
                        <div class="layui-col-md4"></div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script>
    //获取url中的参数
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }

    // 计算文件大小函数(保留两位小数),Size为字节大小
    // size：初始文件大小
    function getfilesize(size) {
        if (!size)
            return "";
        var num = 1024.00; //byte
        if (size < num)
            return size + "B";
        if (size < Math.pow(num, 2))
            return (size / num).toFixed(2) + "K"; //kb
        if (size < Math.pow(num, 3))
            return (size / Math.pow(num, 2)).toFixed(2) + "M"; //M
        if (size < Math.pow(num, 4))
            return (size / Math.pow(num, 3)).toFixed(2) + "G"; //G
        return (size / Math.pow(num, 4)).toFixed(2) + "T"; //T
    }


    layui.use(['form','miniTab'], function () {
        var $ = layui.jquery,
            form = layui.form,
            layer = layui.layer,
            miniTab = layui.miniTab;

        var requestId = getUrlParam('requestId');

        if(requestId != null){
            $("#requestId").val(requestId);
            var loadingIndex = layer.load(2);
            $.ajax({
                url: "/office_automation/public/index.php/index/document_c/getRequestInfo",
                type:'get',
                data: {
                    requestId : requestId
                },
                success: function(res){
                    layer.close(loadingIndex);
                    if(res.code === 0){
                        var data = res.data;
                        $("#projectCode").val(data.project_code);
                        $("#projectStage").val(data.stage);
                        $("#author").val(data.author_name);
                        $("#approver").val(data.approver_name);
                        $("#request_date").val(data.request_time);
                        $("#remark").val(data.remark);
                        $("#reviewOpinion").val(data.review_opinion);
                        $("#reviewDate").val(data.review_time);
                        //上传附件
                        var attachmentList = data.attachments;
                        element = '';
                        for(i in attachmentList) {
                            var size = getfilesize(attachmentList[i].file_size);
                            element += `
                        <tr>
                            <td>${attachmentList[i].source_name}</td>
                            <td>${size}</td>
                            <td>已上传</td>
                            <td>
                                <a class="layui-btn layui-btn-xs download-btn" href="/Office_Automation/public/upload/${attachmentList[i].save_path}" download="${attachmentList[i].source_name}">下载</a>
                            </td>
                        </tr>
                        `;
                        }
                        $('#fileList').append(element);
                        if(data.status === 0){
                            $("#status").append('<span style=\"color:#01AAED;font-size: 25px\" > 待审批</span>');
                        }else if(data.status === 1){
                            $(".download-btn").remove();
                            $("#status").append('<span style="color:#009688;font-size: 25px" > 已通过</span>');
                        }else{
                            $(".download-btn").remove();
                            $("#status").append('<span style="color:#FF5722;font-size: 25px" > 已驳回</span>');
                        }
                        if(data.isAuthor === 0){
                            $("#form-btn").remove();
                            $("#reviewOpinion").attr("disabled",true);
                        }else{
                            $("#reviewDate-item").remove();
                        }
                    }else{
                        var index = layer.alert("数据获取失败！", {
                            title: '提示'
                        });
                    }
                },
                error: function(res){}
            });
        }

        //监听评审通过按钮
        form.on('submit(passBtn)', function (data) {
            var result = data.field;
            layer.confirm('确定通过评审？', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                var loadingIndex = layer.load(2);
                $.ajax({
                    url: "/office_automation/public/index.php/index/document_c/passRequest",
                    type:'post',
                    data: {
                        requestId : requestId,
                        reviewOpinion : result.review_opinion
                    },
                    success: function(res){
                        layer.close(loadingIndex);
                        if(res.code === 0){
                            var index = layer.alert("通过评审!", {
                                title: '提示'
                            }, function () {
                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                parent.layer.close(index); //再执行关闭
                            });
                        }else{
                            layer.msg("评审失败!");
                        }
                    },
                    error: function(res){}
                });
            });
            return false;
        });

        //监听评审驳回按钮
        form.on('submit(noPassBtn)', function (data) {
            var result = data.field;
            layer.confirm('确定驳回？', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                var loadingIndex = layer.load(2);
                $.ajax({
                    url: "/office_automation/public/index.php/index/document_c/noPassRequest",
                    type:'post',
                    data: {
                        requestId : requestId,
                        reviewOpinion : result.review_opinion
                    },
                    success: function(res){
                        layer.close(loadingIndex);
                        if(res.code === 0){
                            var index = layer.alert("已驳回申请!", {
                                title: '提示'
                            }, function () {
                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                parent.layer.close(index); //再执行关闭
                            });
                        }else{
                            layer.msg("驳回失败!");
                        }
                    },
                    error: function(res){}
                });
            });
            return false;
        });

        //监听返回按钮
        $("#back").on("click",function(){
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
        });
    });
</script>
</body>
</html>