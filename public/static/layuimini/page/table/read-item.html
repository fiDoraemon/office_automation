<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>条目详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <link rel="stylesheet" href="../../css/common.css">
    <style>
        /* 上传附件 */
        .layui-upload-drag {
            margin-top: 10px;
            padding-bottom: 0;
        }
        .upload-btn {
            margin-top: 20px;
        }
        .tip {
            width: 85%;
            color: #999;
            font-size: 10px;
            padding-top: 10px;
        }
        /* 链接 */
        .url {
            color: #1E9FFF;
            cursor: pointer;
        }
        .url:hover {
            color: #0567b0;
        }
        /* 任务 */
        .layui-inline .to-mission2 {
            color: #1E9FFF;;
            padding: 9px;
            cursor: pointer;
            display: inline-block;
            margin-right: 5px;
        }
        .layui-inline .to-mission2:hover {
            text-decoration: underline;
        }
        /* 表单标签（暂时） */
        #fields .layui-form-label {
            width: 120px !important;
        }
        #fields .layui-input-block{
            margin-left: 150px !important;
        }
        /* 标签 */
        .layui-form-label {
            font-weight: bold;
        }
        /* 增加表格 */
        .add-table th, .add-table td{
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="layuimini-container">
        <div class="layuimini-main">
            <div class="layui-form layuimini-form" lay-filter="setValue">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                    <legend>基本信息</legend>
                </fieldset>
                <div class="layui-form-item">
                    <label class="layui-form-label required">工作表名称</label>
                    <div class="layui-input-inline">
                        <input type="text" name="table_name" class="layui-input" readonly>
                    </div>
                    <label class="layui-form-label required">标题</label>
                    <div class="layui-input-inline" style="width: 50%">
                        <input type="text" name="item_title" lay-verify="required" lay-reqtext="标题不能为空" autocomplete="off" placeholder="请输入标题" class="layui-input" readonly>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label required">发起人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="creator" class="layui-input" readonly>
                    </div>
                    <label class="layui-form-label required">发起时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="create_time" autocomplete="off" class="layui-input" readonly>
                    </div>
                    <label class="layui-form-label">颜色选择</label>
                    <div class="layui-input-inline">
                        <input type="hidden" name="color">
                        <span class="layui-btn layui-btn-primary select-color" style="padding:0 12px;min-width:45px"></span>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">标签</label>
                    <div class="layui-input-inline" style="width: 30%">
                        <input type="text" name="label_list" id="label-list" class="layui-input" placeholder="请选择或输入任务标签">
                    </div>
                    <div class="layui-input-inline">
                        <select name="label-serach" id="label-serach" lay-filter="label-serach" lay-search>
                            <option value="">直接选择或搜索选择</option>
                        </select>
                    </div>
                    <div class="layui-form-mid layui-word-aux">标签与标签之间需用中文分号分隔(；)</div>
                </div>
                <!-- 字段 -->
                <div id="fields"></div>
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                    <legend>关联任务</legend>
                </fieldset>
                <div class="layui-form-item">
                    <label class="layui-form-label">任务列表</label>
                    <div class="layui-input-block">
                        <table class="layui-hide" id="mission-list" lay-filter="mission-list"></table>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">添加任务</label>
                    <div class="layui-input-block">
                        <table class="layui-table add-table" lay-size="sm">
                            <colgroup>
                                <col width="25%">
                                <col width="15%">
                                <col width="20%">
                                <col width="25%">
                                <col width="15%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>任务标题</th>
                                <th>处理人</th>
                                <th>截止日期</th>
                                <th>任务描述</th>
                                <th><button class="layui-btn layui-btn-sm" id="add-mission">添加</button></th>
                            </tr>
                            </thead>
                            <tbody id="mission-info"></tbody>
                        </table>
                    </div>
                </div>
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                    <legend>处理</legend>
                </fieldset>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">处理意见</label>
                    <div class="layui-input-block">
                        <textarea name="process_note" id="process_note" class="layui-textarea" placeholder="请输入处理意见"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">上传附件</label>
                    <div class="layui-fluid">
                        <div class="layui-row">
                            <div class="layui-col-sm3 layui-col-sm-offset1">
                                <div class="layui-upload-drag" id="attachment">
                                    <i class="layui-icon"></i>
                                    <p>点击上传，或将文件拖拽到此处</p>
                                    <input type="hidden" id="attachment_list" name="attachment_list">
                                    <!--<input type="hidden" id="delete_list" name="delete_list">-->
                                    <button type="button" class="layui-btn upload-btn" id="start_upload" onclick="stopPropagation()">开始上传</button>
                                </div>
                                <div class="tip">提示：1.选择文件后请先点击“开始上传”按钮再提交；2.最多上传10个文件</div>
                            </div>
                            <div class="layui-col-sm8">
                                <div class="layui-upload-list">
                                    <table class="layui-table">
                                        <thead>
                                        <tr>
                                            <th>文件名</th>
                                            <th>大小</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr></thead>
                                        <tbody id="fileList"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item" style="margin: 40px 0;">
                    <div class="layui-input-block">
                        <button class="layui-btn layui-btn-normal return-btn" lay-submit lay-filter="saveBtn">提交</button>
                    </div>
                </div>
            </div>
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                <legend>历史处理信息</legend>
            </fieldset>
            <div class="layui-fluid">
                <div class="layui-row">
                    <div class="layui-col-sm11 layui-col-sm-offset1">
                        <table class="layui-table">
                            <colgroup>
                                <col width="10%">
                                <col width="10%">
                                <col width="15%">
                                <col width="40%">
                                <col width="25%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th>处理人</th>
                                <th>处理时间</th>
                                <th>处理意见</th>
                                <th>附件清单</th>
                            </tr>
                            </thead>
                            <tbody id="item-process"></tbody>
                        </table>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script src="../../js/common.js?v=2" charset="utf-8"></script>
<script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
<script src="../../lib/jq-module/paigusu.min.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'laydate', 'upload', 'tableSelect', 'table'], function () {
        var $ = layui.$,
            form = layui.form,
            layer = layui.layer,
            laydate = layui.laydate,
            upload = layui.upload,
            tableSelect = layui.tableSelect,
            table = layui.table;

        //文件上传
        var fileListView = $('#fileList')
            ,uploadListIns = upload.render({
            elem: '#attachment'
            ,url: '/office_automation/public/attachment'
            ,auto: false
            ,multiple: true
            ,size: 61440            // 单位 KB，最大 60MB
            ,accept: 'file'
            ,bindAction: '#start_upload'
            ,choose: function(obj){
                if($('#fileList').children().length > 9) {
                    return layer.msg('最多上传试9个附件！');
                }
                var files = this.files = obj.pushFile();         // 将每次选择的文件追加到文件队列

                $("#start_upload").removeAttr("disabled");
                // 预读本地文件
                obj.preview(function(index, file, result){          // 分别是文件索引、文件对象、文件base64编码
                    var tr = $(['<tr id="upload-'+ index +'">'
                        ,'<td>'+ file.name +'</td>'
                        ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
                        ,'<td>等待上传</td>'
                        ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs layui-hide reload">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger delete">删除</button>'
                        ,'</td>'
                        ,'</tr>'].join(''));

                    //单个重传
                    tr.find('.reload').on('click', function(){
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.delete').on('click', function(){
                        delete files[index];            // 删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = '';         // 清空 input file 值，以免删除后出现同名文件不可选
                        if(!files) {
                            $("#start_upload").attr("disabled", true);
                        }
                    });

                    fileListView.append(tr);
                });
            }
            ,before: function(obj){
                layer.load();            // 取消上传后仍会触发 before
            }
            ,done: function(res, index, upload){
                if(res.code == 0){
                    // 写入附件 id
                    if($('#attachment_list').val() == '') {
                        $('#attachment_list').val(res.data.id);
                    } else {
                        var ids = $('#attachment_list').val().split(';');
                        if(!ids.includes(res.data.id)) {
                            ids.push(res.data.id);
                        }
                        $('#attachment_list').val(ids.join(';'));
                    }

                    var tr = fileListView.find('tr#upload-'+ index)
                        ,tds = tr.children();
                    tds.eq(3).html('<span style="color: #5FB878;">上传成功</span>');
                    tds.eq(4).html('');
                    delete this.files[index];            // 删除文件队列已经上传成功的文件
                } else {
                    console.log('上传失败：' + res.msg + `(${index})`);
                    this.error(index, upload);
                }
            }
            ,allDone: function(obj){
                layer.closeAll('loading');
                layer.msg('上传完成！');
                $("#start_upload").attr("disabled", true);
                console.log('上传完成！共上传' + obj.total + '个文件，成功文件数：' + obj.successful +'，失败文件数：' + obj.aborted);
            }
            ,error: function(index, upload){            // 分别为当前文件的索引、重新上传的方法
                var tr = fileListView.find('tr#upload-'+ index)
                    ,tds = tr.children();
                tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                tds.eq(3).find('.reload').removeClass('layui-hide');           // 显示重传
            }
        });

        // 获取条目详情
        var radioUserList = [];          // 单选用户字段列表
        var checkUserList = [];          // 多选用户字段列表
        var index = layer.load(2);
        $.get(
            "/office_automation/public/item/" + getQueryVariable('itemId'),
            function(res){
                if(res.code == 0) {
                    // 填充标签选择搜索框
                    var labelList = res.data.labelList;
                    var element = '';
                    for(i in labelList) {
                        element += `<option value="${labelList[i].label_id}">${labelList[i].label_name}</option>`;
                    }
                    $('#label-serach').append(element);
                    form.render('select');
                    // 填充条目详情表单
                    var itemDetail = res.data.itemDetail;
                    form.val("setValue", {
                        "table_name": itemDetail.table_name,
                        'item_title': itemDetail.item_title,
                        'color': itemDetail.color,
                        'creator': itemDetail.creator_name,
                        'create_time': itemDetail.create_time,
                        'label_list': itemDetail.label_list
                    });
                    // 颜色选择
                    $('.select-color').css('background-color', itemDetail.color);
                    $('.select-color').paigusu({
                        color: itemDetail.color,
                    }, function (event, obj) {
                        $(event).css('background-color', '#' + obj.hex);
                        $('input[name="color"]').val('#' + obj.hex);
                    });
                    // 填充条目字段
                    var fields = itemDetail.fields;
                    var fieldValues = {};           // 工作表字段值
                    userIdsList = [];            // 多选用户列表数组
                    var dateList = [];          // 日期字段列表
                    var missionList = [];           // 任务字段列表
                    element = '';
                    for (j in fields) {
                        if(fields[j].type == 'textarea') {
                            var input = $(`
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label">${fields[j].name}</label>
                                <div class="layui-input-block"></div>
                            </div>`);
                        } else if(fields[j].type == 'users'){
                            var input = $(`
                            <div class="layui-form-item">
                                <label class="layui-form-label">${fields[j].name}</label>
                            </div>`);
                        } else if(fields[j].type == 'mission'){
                            var input = $(`
                            <div class="layui-form-item">
                                <label class="layui-form-label">${fields[j].name}</label>
                                <div class="layui-input-inline"></div>
                                <div class="layui-inline" style="width: 70%;"></div>
                            </div>`);
                        } else {
                            var input = $(`
                            <div class="layui-form-item">
                                <label class="layui-form-label">${fields[j].name}</label>
                                <div class="layui-input-block"></div>
                            </div>`);
                        }

                        // 判断字段类型
                        if(fields[j].type == 'textarea') {
                            input.find('.layui-input-block').append(`<textarea name="field${fields[j].field_id}" class="layui-textarea"></textarea>`);
                            fieldValues['field' + fields[j].field_id] = fields[j].field_value;           // 加入赋值数组
                        } else if(fields[j].type == 'select') {
                            var values = fields[j].value.split('，');
                            var select = $(`
                            <select name="field${fields[j].field_id}" lay-filter="field-select">
                                <option value=""></option>
                            </select>`);
                            for(var k in values) {
                                select.append(`<option value="${values[k]}">${values[k]}</option>`);
                            }
                            input.find('.layui-input-block').append(select);
                            if(fields[j].field_value == '') {
                                fieldValues['field' + fields[j].field_id] = values[0];
                            } else {
                                fieldValues['field' + fields[j].field_id] = fields[j].field_value;           // 加入赋值数组
                            }
                        } else if(fields[j].type == 'date') {
                            input.find('.layui-input-block').append(`<input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" autocomplete="off" class="layui-input" readonly>`);
                            dateList.push('field' + fields[j].field_id);
                            fieldValues['field' + fields[j].field_id] = fields[j].field_value;           // 加入赋值数组
                        } else if(fields[j].type == 'user') {
                            if(fields[j].field_value != 0) {
                                input.find('.layui-input-block').append(`<input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" class="layui-input" ts-selected="${fields[j].field_value}" readonly>`);
                                fieldValues['field' + fields[j].field_id] = fields[j].field_value2;           // 加入赋值数组
                            } else {
                                input.find('.layui-input-block').append(`<input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" class="layui-input" readonly>`);
                            }
                            radioUserList.push('field' + fields[j].field_id);
                        } else if(fields[j].type == 'users') {
                            input.append(`
                            <div class="layui-input-inline">
                                <select class="select-department" select-user="field${fields[j].field_id}" lay-filter="multipleSelect-department">
                                    <option value="">请选择部门</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <select name="field${fields[j].field_id}" id="field${fields[j].field_id}" lay-filter="multipleSelect-user">
                                    <option value="">请选择用户</option>
                                </select>
                            </div>
                            <div id="field${fields[j].field_id}-userList" class="multipleSelect"></div>`);
                            var users = fields[j].users;
                            userIdsList['field' + fields[j].field_id] = [];         // 定义已选的全局变量
                            for (i in users) {
                                input.find('.multipleSelect').append(`
                                <a href="javascript:;">
                                    <span lay-value="${users[i].user_id}">${users[i].user_name}</span>
                                    <i class="layui-icon layui-icon-close"></i>
                                </a>
                                `);
                                userIdsList['field' + fields[j].field_id].push(users[i].user_id);           // 加入已选的全局变量
                            }
                            checkUserList.push('field' + fields[j].field_id);
                        } else if(fields[j].type == 'checkbox') {
                            var values = fields[j].value.split('，');
                            for(var k in values) {
                                input.find('.layui-input-block').append(`<input type="checkbox" name="field${fields[j].field_id}[${values[k]}]" title="${values[k]}" lay-filter="customize-check" value="${values[k]}">`);
                            }
                            // 加入赋值数组
                            var array = fields[j].field_value.split(';');
                            for(var i in array) {
                                fieldValues['field' + fields[j].field_id + '[' + array[i] + ']'] = true;
                            }
                        } else if(fields[j].type == 'mission') {
                            input.find('.layui-input-inline').append(`<input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" class="layui-input">`);
                            missionList.push('field' + fields[j].field_id);
                            fieldValues['field' + fields[j].field_id] = fields[j].field_value;
                            for(var i in fields[j].missionList) {
                                input.find('.layui-inline').append(`<div class="to-mission2" mission-id="${fields[j].missionList[i]['mission_id']}">${fields[j].missionList[i]['mission_id']}：${fields[j].missionList[i]['mission_title']}</div>`);
                            }
                        } else {
                            input.find('.layui-input-block').append(`<input type="text" name="field${fields[j].field_id}" class="layui-input">`);
                            fieldValues['field' + fields[j].field_id] = fields[j].field_value;
                        }
                        $('#fields').append(input);
                    }
                    // 渲染表单（下拉选择和复选框）
                    form.render('select', 'add-item');
                    form.render('checkbox', 'add-item');
                    for(i in dateList) {            // 日期
                        laydate.render({
                            elem: '#' + dateList[i]
                        });
                    }
                    for(i in radioUserList) {           // 单选用户
                        userSelectTable('#' + radioUserList[i]);
                    }
                    if(checkUserList.length > 0) {          // 多选用户
                        departmentSelect($, form);
                    }
                    for(var i in missionList) {            // 任务
                        missionSelectTable('#' + missionList[i]);
                    }
                    // 表单赋值
                    form.val("setValue", fieldValues);
                    // 填充处理意见表
                    var processList = itemDetail.processList;
                    element = '';
                    for(i in processList) {
                        var attachmentList = [];
                        var attachments = processList[i].attachments;
                        for (j in attachments) {
                            attachmentList.push(`<a href="${attachments[j].save_path}" download="${attachments[j].source_name}">${attachments[j].source_name}</a>`);
                        }
                        element += `
                        <tr>
                            <td>${Number(i) + 1}</td>
                            <td>${processList[i].handler}</td>
                            <td>${processList[i].process_time}</td>
                            <td><textarea class="layui-textarea" style="min-height: 80px" readonly>${processList[i].process_note}</textarea></td>
                            <td>${attachmentList.join('，')}</td>
                        </tr>
                        `;
                    }
                    $('#item-process').append(element);
                    // 填充条目任务列表
                    var missionList = itemDetail.missionList;
                    table.render({
                        elem: '#mission-list'
                        ,cols: [[
                            {field:'mission_id', width: '10%', title: '任务号', align: "center"}
                            ,{field:'mission_title', width: '30%', title: '任务标题',
                                templet: function(d){
                                    return `<a class="url" lay-event="read">${d.mission_title}</a>`;
                                }
                            },
                            ,{field:'assignee_name', width: '10%', title: '处理人', align: "center"}
                            ,{field:'status', width: '10%', title: '任务状态', align: "center"}
                            ,{field:'finish_date', title: '截止日期', width: '15%', align: "center"}
                            ,{field:'current_process', title: '最近处理信息', width: '30%', align: "center"}
                        ]]
                        ,size: 'sm'
                        ,data: missionList
                    });
                } else {
                    layer.open({
                        type: 0,
                        title: '提示',
                        content: res.msg,
                        icon: 5,
                        anim: 6,
                        yes: function(index, layero){
                            return false;
                        },
                        cancel: function(index, layero){
                            return false;
                        }
                    });
                }
                layer.close(index);
            }
        );

        // 监听操作按钮
        table.on('tool(mission-list)', function (obj) {
            var data = obj.data;
            if (obj.event === 'read') {
                parent.toMissionPage(data.mission_id);
            }
        });

        // 监听选择搜索框
        form.on('select(label-serach)', function(data){
            var labelList = $('#label-list').val().split('；');
            var label_name = $(data.elem).find("option[value='" + data.value + "']").text();

            if(!labelList.includes(label_name)) {
                if($('#label-list').val() == '') {
                    $('#label-list').val(label_name);
                } else {
                    $('#label-list').val($('#label-list').val() + '；' + label_name);
                }
            }
        });

        // 添加任务
        var num = 1;
        $('#add-mission').click(function () {
            let element = $(`
            <tr>
                <td><input type="text" name="mission_title[${num}]" lay-verify="required" lay-reqtext="任务标题不能为空" placeholder="请输入任务标题" autocomplete="off" class="layui-input"></td>
                <td><input type="text" name="assignee[${num}]" id="assignee${num}" lay-verify="required" lay-reqtext="未选择处理人" placeholder="请选择处理人" autocomplete="off" class="layui-input" readonly style="cursor: pointer"></td>
                <td><input type="text" name="finish_date[${num}]" id="finish-date${num}" lay-verify="date" placeholder="请选择截止日期" autocomplete="off" class="layui-input" readonly></td>
                <td><input type="text" name="description[${num}]" lay-verify="required" lay-reqtext="任务描述不能为空" placeholder="请输入任务描述" autocomplete="off" class="layui-input"></td>
                <td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-mission">删除</button></td>
            </tr>
            `);
            $('#mission-info').append(element);
            // 渲染表单（处理人和日期）
            userSelectTable('#assignee' + num);
            laydate.render({
                elem: '#finish-date' + num
            });
            num ++;
        });

        // 删除任务
        $('body').on('click', '.delete-mission', function () {
            $(this).parent().parent().remove();
        });

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            var result = data.field;
            // 处理单选和多选用户
            if(radioUserList.length > 0) {
                for (i in radioUserList) {
                    var userId = $('#' + radioUserList[i]).attr('ts-selected');
                    if(userId == '' || userId == null || userId == undefined) {
                        result[radioUserList[i]] = 0;
                    } else {
                        result[radioUserList[i]] = $('#' + radioUserList[i]).attr('ts-selected');
                    }
                }
            }
            if(checkUserList.length > 0) {
                result.checkUserList = checkUserList.join(';');
                for (i in checkUserList) {
                    result[checkUserList[i]] = userIdsList[checkUserList[i]].join(';');
                }
            } else {
                result.checkUserList = '';
            }
            // 处理新增任务信息
            var missionCount = $('#mission-info').children().length;
            if(missionCount > 0) {
                for (let i in result) {
                    if(i.startsWith('assignee')) {
                        var id = i.substring(9, 10);            // 格式 assignee[id]
                        result[i] = $('#assignee' + id).attr('ts-selected');
                    }
                }
            }
            // 去除多余数据
            delete result.create_time;
            delete result.creator;
            delete result.file;
            delete result['label-serach'];
            delete result.table_name;
            layer.confirm('确定提交？', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                var index = layer.load(2);
                $.ajax({
                    url: "/office_automation/public/item/" + getQueryVariable('itemId'),
                    type: 'put',
                    data: result,
                    success: function(res){
                        layer.close();
                        if (res.code == 0) {
                            layer.alert('提交成功！', {title: '提示'},
                                function (index) {
                                    layer.close(index);
                                    location.reload();
                                }
                            );
                        } else {
                            layer.msg('提交失败！', {icon: 5});
                        }
                    }
                });
            });

            return false;
        });
    });
</script>
</body>
</html>