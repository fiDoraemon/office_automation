<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>条目详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <style>
        body {
            background-color: white;
        }
        /* 上传附件 */
        .layui-upload-drag {
            margin-top: 10px;
            padding-bottom: 0;
        }
        .upload-btn {
            margin-top: 20px;
        }
        .tip {
            width: 85%;
            color: #999;
            font-size: 10px;
            padding-top: 10px;
        }

        /* 标签 */
        .layui-form-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="layui-form layuimini-form" lay-filter="setValue">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>基本信息</legend>
        </fieldset>
        <div class="layui-form-item">
            <label class="layui-form-label required">工作表名称</label>
            <div class="layui-input-inline">
                <input type="text" name="table_name" class="layui-input" readonly>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">标题</label>
            <div class="layui-input-block">
                <input type="text" name="item_title" lay-verify="required" lay-reqtext="标题不能为空" autocomplete="off" placeholder="请输入标题" class="layui-input" readonly>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">发起人</label>
            <div class="layui-input-inline">
                <input type="text" name="creator_id" class="layui-input" readonly>
            </div>
            <label class="layui-form-label required">发起日期</label>
            <div class="layui-input-inline">
                <input type="text" name="create_time" lay-verify="date" placeholder="请选择日期" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">标签</label>
            <div class="layui-input-inline" style="width: 30%">
                <input type="text" name="label_list" id="label-list" class="layui-input" placeholder="请选择或输入任务标签">
            </div>
            <div class="layui-input-inline">
                <select name="label-serach" id="label-serach" lay-filter="label-serach" lay-search>
                    <option value="">直接选择或搜索选择</option>
                </select>
            </div>
            <div class="layui-form-mid layui-word-aux">标签与标签之间需用中文分号分隔(；)</div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">字段1</label>
            <div class="layui-input-block">
                <input type="text" name="field1" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">字段2</label>
            <div class="layui-input-block">
                <input type="text" name="field1" class="layui-input">
            </div>
        </div>
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>处理</legend>
        </fieldset>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">处理意见</label>
            <div class="layui-input-block">
                <textarea name="process_note" id="process_note" class="layui-textarea" placeholder="请输入处理意见"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">上传附件</label>
            <div class="layui-fluid">
                <div class="layui-row">
                    <div class="layui-col-sm3 layui-col-sm-offset1">
                        <div class="layui-upload-drag" id="attachment">
                            <i class="layui-icon"></i>
                            <p>点击上传，或将文件拖拽到此处</p>
                            <input type="hidden" id="attachment_list" name="attachment_list">
                            <!--<input type="hidden" id="delete_list" name="delete_list">-->
                            <button type="button" class="layui-btn upload-btn" id="start_upload" onclick="stopPropagation()">开始上传</button>
                        </div>
                        <div class="tip">提示：1.选择文件后请先点击“开始上传”按钮再提交；2.最多上传10个文件</div>
                    </div>
                    <div class="layui-col-sm8">
                        <div class="layui-upload-list">
                            <table class="layui-table" id="">
                                <thead>
                                <tr>
                                    <th>文件名</th>
                                    <th>大小</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr></thead>
                                <tbody id="fileList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item" style="margin: 40px 0;">
            <div class="layui-input-block">
                <button class="layui-btn layui-btn-normal return-btn" lay-submit lay-filter="saveBtn">提交</button>
            </div>
        </div>
    </div>

    <div class="layui-fluid">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>历史处理信息</legend>
        </fieldset>
        <div class="layui-row">
            <div class="layui-col-sm11 layui-col-sm-offset1">
                <table class="layui-hide" id="process-list" lay-filter="processList"></table>
            </div>
        </div>
    </div>

<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script src="../../js/common.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'laydate', 'upload', 'tableSelect', 'table'], function () {
        var $ = layui.$,
            form = layui.form,
            layer = layui.layer,
            laydate = layui.laydate,
            upload = layui.upload,
            tableSelect = layui.tableSelect,
            table = layui.table;

        //日期
        laydate.render({
            elem: '#create_time'
        });

        //文件上传
        var fileListView = $('#fileList')
            ,uploadListIns = upload.render({
            elem: '#attachment'
            ,url: '/office_automation/public/attachment'
            ,auto: false
            ,multiple: true
            ,size: 20480            // 单位 KB，最大 20MB
            ,accept: 'file'
            ,bindAction: '#start_upload'
            ,choose: function(obj){
                if($('#fileList').children().length > 9) {
                    return layer.msg('最多上传三个附件！');
                }
                var files = this.files = obj.pushFile();         // 将每次选择的文件追加到文件队列

                $("#start_upload").removeAttr("disabled");
                // 预读本地文件
                obj.preview(function(index, file, result){          // 分别是文件索引、文件对象、文件base64编码
                    var tr = $(['<tr id="upload-'+ index +'">'
                        ,'<td>'+ file.name +'</td>'
                        ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
                        ,'<td>等待上传</td>'
                        ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs layui-hide reload">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger delete">删除</button>'
                        ,'</td>'
                        ,'</tr>'].join(''));

                    //单个重传
                    tr.find('.reload').on('click', function(){
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.delete').on('click', function(){
                        delete files[index];            // 删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = '';         // 清空 input file 值，以免删除后出现同名文件不可选
                        if(!files) {
                            $("#start_upload").attr("disabled", true);
                        }
                    });

                    fileListView.append(tr);
                });
            }
            ,before: function(obj){
                layer.load();            // 取消上传后仍会触发 before
            }
            ,done: function(res, index, upload){
                if(res.code == 0){
                    // 写入附件 id
                    if($('#attachment_list').val() == '') {
                        $('#attachment_list').val(res.data.id);
                    } else {
                        var ids = $('#attachment_list').val().split(';');
                        if(!ids.includes(res.data.id)) {
                            ids.push(res.data.id);
                        }
                        $('#attachment_list').val(ids.join(';'));
                    }

                    var tr = fileListView.find('tr#upload-'+ index)
                        ,tds = tr.children();
                    tds.eq(3).html('<span style="color: #5FB878;">上传成功</span>');
                    tds.eq(4).html('');
                    delete this.files[index];            // 删除文件队列已经上传成功的文件
                } else {
                    console.log('上传失败：' + res.msg + `(${index})`);
                    this.error(index, upload);
                }
            }
            ,allDone: function(obj){
                layer.closeAll('loading');
                layer.msg('上传完成！');
                $("#start_upload").attr("disabled", true);
                console.log('上传完成！共上传' + obj.total + '个文件，成功文件数：' + obj.successful +'，失败文件数：' + obj.aborted);
            }
            ,error: function(index, upload){            // 分别为当前文件的索引、重新上传的方法
                var tr = fileListView.find('tr#upload-'+ index)
                    ,tds = tr.children();
                tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                tds.eq(3).find('.reload').removeClass('layui-hide');           // 显示重传
            }
        });

        // 填充部门下拉列表
        $.get(
            "/office_automation/public/index.php/index/user_c/getAllDepartment",
            function(res){
                if(res.code == 0) {
                    var processList = res.data.processList;
                    table.render({
                        elem: '#process-list'
                        ,cols: [[
                            {field:'id', width: '10%', title: '序号', align: "center", sort: true}
                            ,{field:'handler_id', width: '15%', title: '处理人'}
                            ,{field:'process_time', width: '15%', title: '处理时间'}
                            ,{field:'process_note', width: '35%', title: '处理意见'}
                            ,{field:'attachmen_list', width: '25%', title: '附件清单'}
                        ]]
                        ,data: [
                            {id:1,handler_id:'郑灿拥',process_time:'2020-01-01',process_note:'还可以',attachmen_list:'123.doc'}
                        ]
                    });
                }
            }
        );

        // 监听选择搜索框
        form.on('select(label-serach)', function(data){
            var labelList = $('#label-list').val().split('；');
            var label_name = $(data.elem).find("option[value='" + data.value + "']").text();

            if(!labelList.includes(label_name)) {
                if($('#label-list').val() == '') {
                    $('#label-list').val(label_name);
                } else {
                    $('#label-list').val($('#label-list').val() + '；' + label_name);
                }
            }
        });

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            var result = data.field;
            layer.confirm('确定提交？', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                var index = layer.load(2);
                $.ajax({
                    url: "/office_automation/public/item/" + result.mission_id,
                    type: 'put',
                    data: result,
                    success: function(res){
                        index.close();
                        if (res.code == 0) {
                            layer.alert('提交成功！', {title: '提示'},
                                function (index) {
                                    layer.close(index);
                                    location.reload();
                                }
                            );
                        } else {
                            layer.msg('提交失败！');
                        }
                    }
                });
            });

            return false;
        });
    });
</script>
</body>
</html>