<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>条目详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <link rel="stylesheet" href="../../css/common.css">
    <style>
        body {
            background-color: white;
        }
        /* 上传附件 */
        .layui-upload-drag {
            margin-top: 10px;
            padding-bottom: 0;
        }
        .upload-btn {
            margin-top: 20px;
        }
        .tip {
            width: 85%;
            color: #999;
            font-size: 10px;
            padding-top: 10px;
        }

        /* 表单标签（暂时） */
        #fields .layui-form-label {
            width: 120px !important;
        }
        #fields .layui-input-block{
            margin-left: 150px !important;
        }

        /* 标签 */
        .layui-form-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="layui-form layuimini-form" lay-filter="setValue">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>基本信息</legend>
        </fieldset>
        <div class="layui-form-item">
            <label class="layui-form-label required">工作表名称</label>
            <div class="layui-input-inline">
                <input type="text" name="table_name" class="layui-input" readonly>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">标题</label>
            <div class="layui-input-block">
                <input type="text" name="item_title" lay-verify="required" lay-reqtext="标题不能为空" autocomplete="off" placeholder="请输入标题" class="layui-input" readonly>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">发起人</label>
            <div class="layui-input-inline">
                <input type="text" name="creator" class="layui-input" readonly>
            </div>
            <label class="layui-form-label required">发起时间</label>
            <div class="layui-input-inline">
                <input type="text" name="create_time" autocomplete="off" class="layui-input" readonly>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">标签</label>
            <div class="layui-input-inline" style="width: 30%">
                <input type="text" name="label_list" id="label-list" class="layui-input" placeholder="请选择或输入任务标签">
            </div>
            <div class="layui-input-inline">
                <select name="label-serach" id="label-serach" lay-filter="label-serach" lay-search>
                    <option value="">直接选择或搜索选择</option>
                </select>
            </div>
            <div class="layui-form-mid layui-word-aux">标签与标签之间需用中文分号分隔(；)</div>
        </div>
        <!-- 字段 -->
        <div id="fields"></div>
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>处理</legend>
        </fieldset>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">处理意见</label>
            <div class="layui-input-block">
                <textarea name="process_note" id="process_note" class="layui-textarea" placeholder="请输入处理意见"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">上传附件</label>
            <div class="layui-fluid">
                <div class="layui-row">
                    <div class="layui-col-sm3 layui-col-sm-offset1">
                        <div class="layui-upload-drag" id="attachment">
                            <i class="layui-icon"></i>
                            <p>点击上传，或将文件拖拽到此处</p>
                            <input type="hidden" id="attachment_list" name="attachment_list">
                            <!--<input type="hidden" id="delete_list" name="delete_list">-->
                            <button type="button" class="layui-btn upload-btn" id="start_upload" onclick="stopPropagation()">开始上传</button>
                        </div>
                        <div class="tip">提示：1.选择文件后请先点击“开始上传”按钮再提交；2.最多上传10个文件</div>
                    </div>
                    <div class="layui-col-sm8">
                        <div class="layui-upload-list">
                            <table class="layui-table" id="">
                                <thead>
                                <tr>
                                    <th>文件名</th>
                                    <th>大小</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr></thead>
                                <tbody id="fileList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item" style="margin: 40px 0;">
            <div class="layui-input-block">
                <button class="layui-btn layui-btn-normal return-btn" lay-submit lay-filter="saveBtn">提交</button>
            </div>
        </div>
    </div>

    <div class="layui-fluid">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>历史处理信息</legend>
        </fieldset>
        <div class="layui-row">
            <div class="layui-col-sm11 layui-col-sm-offset1">
                <table class="layui-table">
                    <colgroup>
                        <col width="10%">
                        <col width="10%">
                        <col width="15%">
                        <col width="40%">
                        <col width="25%">
                    </colgroup>
                    <thead>
                    <tr>
                        <th>序号</th>
                        <th>处理人</th>
                        <th>处理时间</th>
                        <th>处理意见</th>
                        <th>附件清单</th>
                    </tr>
                    </thead>
                    <tbody id="item-process"></tbody>
                </table>
            </div>
            </div>
        </div>
    </div>

<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script src="../../js/common.js?v=1" charset="utf-8"></script>
<script>
    layui.use(['form', 'laydate', 'upload', 'tableSelect', 'table'], function () {
        var $ = layui.$,
            form = layui.form,
            layer = layui.layer,
            laydate = layui.laydate,
            upload = layui.upload,
            tableSelect = layui.tableSelect,
            table = layui.table;

        //日期
        laydate.render({
            elem: '#create_time'
        });

        //文件上传
        var fileListView = $('#fileList')
            ,uploadListIns = upload.render({
            elem: '#attachment'
            ,url: '/office_automation/public/attachment'
            ,auto: false
            ,multiple: true
            ,size: 51200            // 单位 KB，最大 50MB
            ,accept: 'file'
            ,bindAction: '#start_upload'
            ,choose: function(obj){
                if($('#fileList').children().length > 9) {
                    return layer.msg('最多上传试9个附件！');
                }
                var files = this.files = obj.pushFile();         // 将每次选择的文件追加到文件队列

                $("#start_upload").removeAttr("disabled");
                // 预读本地文件
                obj.preview(function(index, file, result){          // 分别是文件索引、文件对象、文件base64编码
                    var tr = $(['<tr id="upload-'+ index +'">'
                        ,'<td>'+ file.name +'</td>'
                        ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
                        ,'<td>等待上传</td>'
                        ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs layui-hide reload">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger delete">删除</button>'
                        ,'</td>'
                        ,'</tr>'].join(''));

                    //单个重传
                    tr.find('.reload').on('click', function(){
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.delete').on('click', function(){
                        delete files[index];            // 删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = '';         // 清空 input file 值，以免删除后出现同名文件不可选
                        if(!files) {
                            $("#start_upload").attr("disabled", true);
                        }
                    });

                    fileListView.append(tr);
                });
            }
            ,before: function(obj){
                layer.load();            // 取消上传后仍会触发 before
            }
            ,done: function(res, index, upload){
                if(res.code == 0){
                    // 写入附件 id
                    if($('#attachment_list').val() == '') {
                        $('#attachment_list').val(res.data.id);
                    } else {
                        var ids = $('#attachment_list').val().split(';');
                        if(!ids.includes(res.data.id)) {
                            ids.push(res.data.id);
                        }
                        $('#attachment_list').val(ids.join(';'));
                    }

                    var tr = fileListView.find('tr#upload-'+ index)
                        ,tds = tr.children();
                    tds.eq(3).html('<span style="color: #5FB878;">上传成功</span>');
                    tds.eq(4).html('');
                    delete this.files[index];            // 删除文件队列已经上传成功的文件
                } else {
                    console.log('上传失败：' + res.msg + `(${index})`);
                    this.error(index, upload);
                }
            }
            ,allDone: function(obj){
                layer.closeAll('loading');
                layer.msg('上传完成！');
                $("#start_upload").attr("disabled", true);
                console.log('上传完成！共上传' + obj.total + '个文件，成功文件数：' + obj.successful +'，失败文件数：' + obj.aborted);
            }
            ,error: function(index, upload){            // 分别为当前文件的索引、重新上传的方法
                var tr = fileListView.find('tr#upload-'+ index)
                    ,tds = tr.children();
                tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                tds.eq(3).find('.reload').removeClass('layui-hide');           // 显示重传
            }
        });

        // 获取条目详情
        var radioUserList = [];          // 单选用户字段列表
        var checkUserList = [];          // 多选用户字段列表
        var index = layer.load(2);
        $.get(
            "/office_automation/public/item/" + getQueryVariable('itemId'),
            function(res){
                if(res.code == 0) {
                    // 填充标签选择搜索框
                    var labelList = res.data.labelList;
                    var element = '';
                    for(i in labelList) {
                        element += `<option value="${labelList[i].label_id}">${labelList[i].label_name}</option>`;
                    }
                    $('#label-serach').append(element);
                    form.render('select');
                    // 填充条目详情表单
                    var itemDetail = res.data.itemDetail;
                    form.val("setValue", {
                        "table_name": itemDetail.table_name,
                        'item_title' : itemDetail.item_title,
                        'creator' : itemDetail.creator_name,
                        'create_time' : itemDetail.create_time,
                        'label_list' : itemDetail.label_list
                    });
                    // 填充条目字段
                    var fields = itemDetail.fields;
                    var fieldValues = {};           // 工作表字段值
                    userIdsList = [];            // 多选用户列表数组
                    element = '';
                    for (j in fields) {
                        var attr = '';          // textarea 属性
                        var dateList = [];          // 日期字段列表
                        // 判断字段类型
                        if(fields[j].type == 'textarea') {
                            var input = `<div class="layui-input-block"><textarea name="field${fields[j].field_id}" class="layui-textarea"></textarea></div>`;
                            attr = ' layui-form-text';
                        } else if(fields[j].type == 'select') {
                            var values = fields[j].value.split('；');
                            var input = `
                                <div class="layui-input-block">
                                    <select name="field${fields[j].field_id}" lay-filter="field-select">
                                        <option value=""></option>
                                `;
                            for(k in values) {
                                input += `<option value="${values[k]}">${values[k]}</option>`;
                            }
                            input += `</select></div>`;
                        } else if(fields[j].type == 'date') {
                            var input = `<div class="layui-input-block"><input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" autocomplete="off" class="layui-input" readonly></div>`;
                            dateList.push('field' + fields[j].field_id);
                        } else if(fields[j].type == 'user') {
                            var input = `<div class="layui-input-block"><input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" class="layui-input" ts-selected="${fields[j].field_value}" readonly></div>`;
                            fields[j].field_value = fields[j].field_value2;
                            radioUserList.push('field' + fields[j].field_id);
                        } else if(fields[j].type == 'users') {
                            var input = `
                            <div class="layui-input-inline">
                                <select class="select-department" select-user="field${fields[j].field_id}" lay-filter="multipleSelect-department">
                                    <option value="">请选择部门</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <select name="field${fields[j].field_id}" id="field${fields[j].field_id}" lay-filter="multipleSelect-user">
                                    <option value="">请选择用户</option>
                                </select>
                            </div>
                            `;
                            var UserListDiv = `<div id="field${fields[j].field_id}-userList" class="multipleSelect">`;
                            var users = fields[j].users;
                            userIdsList['field' + fields[j].field_id] = [];         // 定义已选的全局变量
                            for (i in users) {
                                UserListDiv += `
                                <a href="javascript:;">
                                    <span lay-value="${users[i].user_id}">${users[i].user_name}</span>
                                    <i class="layui-icon layui-icon-close"></i></a>
                                `;
                                userIdsList['field' + fields[j].field_id].push(users[i].user_id);           // 加入已选的全局变量
                            }
                            UserListDiv += `</div>`;
                            input += UserListDiv;
                            checkUserList.push('field' + fields[j].field_id);
                        } else {
                            var input = `<div class="layui-input-block"><input type="text" name="field${fields[j].field_id}" class="layui-input"></div>`;
                        }
                        fieldValues['field' + fields[j].field_id] = fields[j].field_value;
                        element += `
                        <div class="layui-form-item${attr}">
                            <label class="layui-form-label">${fields[j].name}</label>
                            ${input}
                        </div>
                        `;
                    }
                    $('#fields').append(element);
                    // 表单赋值
                    console.log(fieldValues);
                    form.val("setValue", fieldValues);
                    // 渲染表单
                    form.render('select');          // 下拉选择
                    for(i in dateList) {            // 日期
                        laydate.render({
                            elem: '#' + dateList[i]
                        });
                    }
                    for(i in radioUserList) {           // 单选用户
                        userSelectTable(tableSelect, '#' + radioUserList[i]);
                    }
                    if(checkUserList.length > 0) {          // 多选用户
                        departmentSelect($, form);
                    }
                    // 填充处理意见表
                    var processList = itemDetail.processList;
                    element = '';
                    for(i in processList) {
                        var attachmentList = [];
                        var attachments = processList[i].attachments;
                        for (j in attachments) {
                            attachmentList.push(`<a href="${attachments[j].save_path}" download="${attachments[j].source_name}">${attachments[j].source_name}</a>`);
                        }
                        element += `
                        <tr>
                            <td>${Number(i) + 1}</td>
                            <td>${processList[i].handler}</td>
                            <td>${processList[i].process_time}</td>
                            <td><textarea class="layui-textarea" style="min-height: 80px" readonly>${processList[i].process_note}</textarea></td>
                            <td>${attachmentList.join('，')}</td>
                        </tr>
                        `;
                    }
                    $('#item-process').append(element);
                }
                layer.close(index);
            }
        );

        // 监听选择搜索框
        form.on('select(label-serach)', function(data){
            var labelList = $('#label-list').val().split('；');
            var label_name = $(data.elem).find("option[value='" + data.value + "']").text();

            if(!labelList.includes(label_name)) {
                if($('#label-list').val() == '') {
                    $('#label-list').val(label_name);
                } else {
                    $('#label-list').val($('#label-list').val() + '；' + label_name);
                }
            }
        });

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            var result = data.field;
            console.log(result);
            // 处理单选和多选用户
            if(radioUserList.length > 0) {
                for (i in radioUserList) {
                    result[radioUserList[i]] = $('#' + radioUserList[i]).attr('ts-selected');
                }
            }
            if(checkUserList.length > 0) {
                result.checkUserList = checkUserList.join(';');
                for (i in checkUserList) {
                    result[checkUserList[i]] = userIdsList[checkUserList[i]].join(';');
                }
            }
            // 去除多余数据
            delete result.create_time;
            delete result.creator;
            delete result.file;
            delete result['label-serach'];
            delete result.table_name;

            layer.confirm('确定提交？', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                var index = layer.load(2);
                $.ajax({
                    url: "/office_automation/public/item/" + getQueryVariable('itemId'),
                    type: 'put',
                    data: result,
                    success: function(res){
                        layer.close();
                        if (res.code == 0) {
                            layer.alert('提交成功！', {title: '提示'},
                                function (index) {
                                    layer.close(index);
                                    location.reload();
                                }
                            );
                        } else {
                            layer.msg('提交失败！', {icon: 5});
                        }
                    }
                });
            });

            return false;
        });
    });
</script>
</body>
</html>