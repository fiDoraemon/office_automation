<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>填写工作表</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <link rel="stylesheet" href="../../css/common.css">
    <style>
        /* 表单标签（暂时） */
        #fields .layui-form-label {
            width: 120px !important;
        }
        #fields .layui-input-block{
            margin-left: 150px !important;
        }
        /* 标签 */
        .layui-form-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="layuimini-container">
        <div class="layuimini-main">
            <form class="layui-form layuimini-form" lay-filter="add-item">
                <div class="layui-form-item">
                    <label class="layui-form-label required">工作表</label>
                    <div class="layui-input-inline" style="width: 30%">
                        <input type="text" id="table-name" autocomplete="off" class="layui-input" readonly>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label required">标题</label>
                    <div class="layui-input-block">
                        <input type="text" name="item_title" lay-verify="required" lay-reqtext="标题不能为空" autocomplete="off" placeholder="请输入标题" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">标签</label>
                    <div class="layui-input-inline" style="width: 30%">
                        <input type="text" name="label_list" id="label-list" class="layui-input" autocomplete="off" placeholder="请选择或输入任务标签">
                    </div>
                    <div class="layui-input-inline">
                        <select id="label-serach" lay-filter="label-serach" lay-search>
                            <option value="">直接选择或搜索选择</option>
                        </select>
                    </div>
                    <div class="layui-form-mid layui-word-aux">标签与标签之间需用中文分号分隔(；)</div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">颜色选择</label>
                    <div class="layui-input-block">
                        <input type="hidden" name="color" value="#666">
                        <span class="layui-btn layui-btn-primary select-color" style="padding:0 12px;min-width:45px;background-color: #666;"></span>
                    </div>
                </div>
                <!-- 字段 -->
                <div id="fields"></div>
                <div class="layui-form-item" style="margin-top: 40px">
                    <div class="layui-input-block">
                        <button class="layui-btn layui-btn-normal return-btn" lay-submit lay-filter="saveBtn">提交</button>
                        <button type="reset" id="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script src="../../js/common.js?v=1" charset="utf-8"></script>
<script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
<script src="../../lib/jq-module/paigusu.min.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'laydate', 'tableSelect', 'miniTab'], function () {
        var $ = layui.$,
            form = layui.form,
            layer = layui.layer,
            laydate = layui.laydate,
            upload = layui.upload,
            tableSelect = layui.tableSelect,
            miniTab = layui.miniTab;
        // 颜色选择
        $('.select-color').paigusu({
            color: '#666',           //初始色
        }, function (event, obj) {          // 元素，对象
            $(event).css('background-color', '#' + obj.hex);
            $('input[name="color"]').val('#' + obj.hex);
        });
        // 获取信息
        var dateList = [];          // 日期字段列表
        var radioUserList = [];          // 单选用户字段列表
        var checkUserList = [];          // 多选用户字段列表
        var missionList = [];           // 任务字段列表
        var index = layer.load(2);
        $.get(
            "/office_automation/public/item/create?tableId=" + getQueryVariable('tableId'),
            function (res) {
                if(res.code == 0) {
                    var tableName = res.data.tableName;
                    $('#table-name').val(tableName);
                    // 填充标签选择搜索框
                    var labelList = res.data.labelList;
                    var element = '';
                    for(i in labelList) {
                        element += `<option value="${labelList[i].label_id}">${labelList[i].label_name}</option>`;
                    }
                    $('#label-serach').append(element);
                    form.render('select');
                    // 填充工作表字段
                    var fields = res.data.fields;
                    for (j in fields) {
                        if(fields[j].type == 'textarea') {
                            var input = $(`
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label">${fields[j].name}</label>
                                <div class="layui-input-block"></div>
                            </div>`);
                        } else if(fields[j].type == 'users'){
                            var input = $(`
                            <div class="layui-form-item">
                                <label class="layui-form-label">${fields[j].name}</label>
                            </div>`);
                        } else {
                            var input = $(`
                            <div class="layui-form-item">
                                <label class="layui-form-label">${fields[j].name}</label>
                                <div class="layui-input-block"></div>
                            </div>`);
                        }
                        // 判断字段类型
                        if(fields[j].type == 'textarea') {
                            input.find('.layui-input-block').append(`<textarea name="field${fields[j].field_id}" class="layui-textarea"></textarea>`);
                        } else if(fields[j].type == 'select') {
                            var values = fields[j].value.split('，');
                            var select = $(`
                            <select name="field${fields[j].field_id}" lay-filter="field-select">
                                <option value=""></option>
                            </select>`);
                            for(var k in values) {
                                select.append(`<option value="${values[k]}">${values[k]}</option>`);
                            }
                            input.find('.layui-input-block').append(select);
                        } else if(fields[j].type == 'date') {
                            input.find('.layui-input-block').append(`<input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" autocomplete="off" class="layui-input" readonly>`);
                            dateList.push('field' + fields[j].field_id);
                        } else if(fields[j].type == 'user') {
                            input.find('.layui-input-block').append(`<input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" class="layui-input" readonly>`);
                            radioUserList.push('field' + fields[j].field_id);
                        } else if(fields[j].type == 'users') {
                            input.append(`
                            <div class="layui-input-inline">
                                <select class="select-department" select-user="field${fields[j].field_id}" lay-filter="multipleSelect-department">
                                    <option value="">请选择部门</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <select name="field${fields[j].field_id}" id="field${fields[j].field_id}" lay-filter="multipleSelect-user">
                                    <option value="">请选择用户</option>
                                </select>
                            </div>
                            <div id="field${fields[j].field_id}-userList" class="multipleSelect"></div>`);
                            checkUserList.push('field' + fields[j].field_id);
                        } else if(fields[j].type == 'checkbox') {
                            var values = fields[j].value.split('，');
                            for(var k in values) {
                                input.find('.layui-input-block').append(`<input type="checkbox" name="field${fields[j].field_id}[]" title="${values[k]}" lay-filter="customize-check" value="${values[k]}">`);
                            }
                        } else if(fields[j].type == 'mission') {
                            input.find('.layui-input-block').append(`<input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" class="layui-input" autocomplete="off">`);
                            missionList.push('field' + fields[j].field_id);
                        } else {
                            input.find('.layui-input-block').append(`<input type="text" name="field${fields[j].field_id}" class="layui-input">`);
                        }
                        $('#fields').append(input);
                    }
                    // 渲染表单（下拉选择和复选框）
                    form.render('select', 'add-item');
                    form.render('checkbox', 'add-item');
                    for(var i in dateList) {            // 日期
                        laydate.render({
                            elem: '#' + dateList[i]
                        });
                    }
                    for(var i in radioUserList) {           // 单选用户
                        userSelectTable('#' + radioUserList[i]);
                    }
                    userIdsList = [];            // 多选用户列表数组
                    if(checkUserList.length > 0) {          // 多选用户
                        departmentSelect($, form);
                        // 定义多个多选用户全局变量
                        for(var i in checkUserList) {
                            userIdsList[checkUserList[i]] = [];
                        }
                    }
                    for(var i in missionList) {            // 任务
                        missionSelectTable('#' + missionList[i]);
                    }
                    layer.close(index);
                }
            }
        );

        // 监听标签选择搜索框
        form.on('select(label-serach)', function(data){
            var labelList = $('#label-list').val().split('；');
            var label_name = $(data.elem).find("option[value='" + data.value + "']").text();

            if(!labelList.includes(label_name)) {
                if($('#label-list').val() == '') {
                    $('#label-list').val(label_name);
                } else {
                    $('#label-list').val($('#label-list').val() + '；' + label_name);
                }
            }
        });

        form.on('checkbox(customize-check)', function(data){
            console.log(data.value); //复选框value值，也可以通过data.elem.value得到
        });

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            var result = data.field;
            result.table_id = getQueryVariable('tableId');
            if(result.label_list.includes(';')) {
                layer.msg('标签列表需用中文分号；分隔', {icon: 5});
                return false;
            }
            // 处理任务
            if(missionList.length > 0) {
                // result = true;
                // for (var i in missionList) {
                //     $.ajax({
                //         url: '/office_automation/public/index/table_item_c/checkMission?missionList=' + result[missionList[i]],
                //         async: false,           // 同步
                //         success: function (res) {
                //             if(res.code != 0) {
                //                 result = false;
                //             }
                //         }
                //     });
                // }
                // if(!result) {
                //     layer.msg('任务字段值中的任务不存在', {icon: 5});
                //     return false;
                // }
            }
            // 处理单选和多选用户
            if(radioUserList.length > 0) {
                for (i in radioUserList) {
                    var userId = $('#' + radioUserList[i]).attr('ts-selected');
                    if(userId == '' || userId == null || userId == undefined) {
                        result[radioUserList[i]] = 0;
                    } else {
                        result[radioUserList[i]] = $('#' + radioUserList[i]).attr('ts-selected');
                    }
                }
            }
            if(checkUserList.length > 0) {
                result.checkUserList = checkUserList.join(';');
                for (i in checkUserList) {
                    result[checkUserList[i]] = userIdsList[checkUserList[i]].join(';');
                }
            } else {
                result.checkUserList = '';
            }
            layer.confirm('确定提交？', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                var index = layer.load(2);
                $.post(
                    "/office_automation/public/item",
                    result,
                    function (res) {
                        layer.close(index);
                        if (res.code == 0) {
                            layer.alert('提交成功！', {title: '提示'},
                                function (index) {
                                    layer.close(index);
                                    // 刷新父页面表格
                                    parent.reloadTable();
                                    var index = parent.layer.getFrameIndex(window.name);
                                    parent.layer.close(index);
                                }
                            );
                        } else {
                            layer.msg('提交失败！');
                        }
                    }
                );
                layer.close(index);
            });

            return false;
        });
    });
</script>
</body>
</html>