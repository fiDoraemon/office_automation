<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>填写工作表</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <style>
        /* 多选 */
        .layui-form-item .multipleSelect a {
            padding: 2px 5px;
            background: #908e8e;
            border-radius: 2px;
            color: #fff;
            display: block;
            line-height: 20px;
            height: 20px;
            margin: 7px 4px 3px 2px;
            float: left;
        }
        .layui-form-item .multipleSelect i {
            margin-left: 4px;
        }
        .layui-form-item .multipleSelect a:link {
            color:#fff;
        }
        .layui-form-item a:-webkit-any-link {
            color: -webkit-link;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="layuimini-container" style="padding: 30px 30px;">
        <div class="layuimini-main">
            <form class="layui-form layui-form-pane" lay-filter="add-item">
                <div class="layui-form-item">
                    <label class="layui-form-label">工作表</label>
                    <div class="layui-input-inline" style="width: 30%">
                        <select name="table_id" id="work-table" lay-filter="work-table" lay-verify="required" lay-reqtext="请选择工作表">
                            <option value=""></option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">标题</label>
                    <div class="layui-input-block">
                        <input type="text" name="item_title" lay-verify="required" lay-reqtext="标题不能为空" autocomplete="off" placeholder="请输入标题" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">标签</label>
                    <div class="layui-input-inline" style="width: 30%">
                        <input type="text" name="label_list" id="label-list" class="layui-input" autocomplete="off" placeholder="请选择或输入任务标签">
                    </div>
                    <div class="layui-input-inline">
                        <select id="label-serach" lay-filter="label-serach" lay-search>
                            <option value="">直接选择或搜索选择</option>
                        </select>
                    </div>
                    <div class="layui-form-mid layui-word-aux">标签与标签之间需用中文分号分隔(；)</div>
                </div>
                <!-- 字段 -->
                <div id="fields"></div>
                <div class="layui-form-item" style="margin-top: 40px">
                    <div class="layui-input-block">
                        <button class="layui-btn layui-btn-normal return-btn" lay-submit lay-filter="saveBtn">提交</button>
                        <button type="reset" id="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script src="../../js/common.js?v=1" charset="utf-8"></script>
<script>
    layui.use(['form', 'laydate', 'tableSelect', 'miniTab'], function () {
        var $ = layui.$,
            form = layui.form,
            layer = layui.layer,
            laydate = layui.laydate,
            upload = layui.upload,
            tableSelect = layui.tableSelect,
            miniTab = layui.miniTab;

        // 渲染表单
        function renderTable(value) {
            var fields;
            for(i in tableList) {
                if (tableList[i].table_id == value) {
                    fields = tableList[i].fields;
                }
            }
            // 切换工作表字段
            $('#fields').empty();
            var element = '';
            for (j in fields) {
                var attr = '';          // textarea 属性
                var dateList = [];          // 日期字段列表
                // 判断字段类型
                if(fields[j].type == 'textArea') {
                    var input = `<div class="layui-input-block"><textarea name="field${fields[j].field_id}" class="layui-textarea"></textarea></div>`;
                    attr = ' layui-form-text';
                } else if(fields[j].type == 'select') {
                    var values = fields[j].value.split('；');
                    var input = `
                        <div class="layui-input-block">
                            <select name="field${fields[j].field_id}" lay-filter="field-select">
                                <option value=""></option>
                        `;
                    for(k in values) {
                        input += `<option value="${values[k]}">${values[k]}</option>`;
                    }
                    input += `</select></div>`;
                } else if(fields[j].type == 'date') {
                    var input = `<div class="layui-input-block"><input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" autocomplete="off" class="layui-input" readonly></div>`;
                    dateList.push('field' + fields[j].field_id);
                } else if(fields[j].type == 'user') {
                    var input = `<div class="layui-input-block"><input type="text" name="field${fields[j].field_id}" id="field${fields[j].field_id}" class="layui-input" readonly></div>`;
                    radioUserList.push('field' + fields[j].field_id);
                } else if(fields[j].type == 'users') {
                    var input = `
                        <div class="layui-input-inline">
                            <select class="select-department" select-user="field${fields[j].field_id}" lay-filter="multipleSelect-department">
                                <option value="">请选择部门</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select name="field${fields[j].field_id}" id="field${fields[j].field_id}" lay-filter="multipleSelect-user">
                                <option value="">请选择用户</option>
                            </select>
                        </div>
                        <div id="field${fields[j].field_id}-userList" class="multipleSelect"></div>
                        `;
                    checkUserList.push('field' + fields[j].field_id);
                } else {
                    var input = `<div class="layui-input-block"><input type="text" name="field${fields[j].field_id}" class="layui-input"></div>`;
                }
                element += `
                    <div class="layui-form-item${attr}">
                        <label class="layui-form-label">${fields[j].name}</label>
                        ${input}
                    </div>
                    `;
            }
            $('#fields').append(element);
            // 渲染表单
            form.render('select', 'add-item');          // 下拉选择
            for(i in dateList) {            // 日期
                laydate.render({
                    elem: '#' + dateList[i]
                });
            }
            for(i in radioUserList) {           // 单选用户
                userSelectTable(tableSelect, '#' + radioUserList[i]);
            }
            userIdsList = [];            // 多选用户列表数组
            if(checkUserList.length > 0) {          // 多选用户
                departmentSelect($, form);
                // 定义多个多选用户全局变量
                for(i in checkUserList) {
                    userIdsList[checkUserList[i]] = [];
                }
            }
        }

        // 获取信息
        var tableList;
        var index = layer.load(2);
        $.get(
            "/office_automation/public/item/create",
            function (res) {
                if(res.code == 0) {
                    // 填充工作表下拉列表
                    tableList = res.data.tableList;
                    var element = '';
                    for(i in tableList) {
                        element += `<option value="${tableList[i].table_id}">${tableList[i].table_name}</option>`;
                    }
                    $('#work-table').append(element);
                    // 填充标签选择搜索框
                    var labelList = res.data.labelList;
                    element = '';
                    for(i in labelList) {
                        element += `<option value="${labelList[i].label_id}">${labelList[i].label_name}</option>`;
                    }
                    $('#label-serach').append(element);
                    form.render('select');
                    if(tableList.length > 0) {
                        form.val("add-item", {
                            "table_id": tableList[0].table_id,
                        });
                        renderTable(tableList[0].table_id);
                    }
                    layer.close(index);
                }
            }
        );

        // 监听工作表下拉选择
        var worktable;
        var radioUserList = [];          // 单选用户字段列表
        var checkUserList = [];          // 多选用户字段列表
        form.on('select(work-table)', function(data){
            if(data.value != worktable) {
                var index = layer.load(2);
                renderTable(data.value);
                layer.close(index);
                worktable = data.value;
            }
        });

        // 监听标签选择搜索框
        form.on('select(label-serach)', function(data){
            var labelList = $('#label-list').val().split('；');
            var label_name = $(data.elem).find("option[value='" + data.value + "']").text();

            if(!labelList.includes(label_name)) {
                if($('#label-list').val() == '') {
                    $('#label-list').val(label_name);
                } else {
                    $('#label-list').val($('#label-list').val() + '；' + label_name);
                }
            }
        });

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            var result = data.field;
            if(result.label_list.includes(';')) {
                layer.msg('标签列表需用中文分号；分隔', {icon: 5});
                return false;
            }
            // 处理单选和多选用户
            if(radioUserList.length > 0) {
                for (i in radioUserList) {
                    result[radioUserList[i]] = $('#' + radioUserList[i]).attr('ts-selected');
                }
            }
            if(checkUserList.length > 0) {
                result.checkUserList = checkUserList.join(';');
                for (i in checkUserList) {
                    result[checkUserList[i]] = userIdsList[checkUserList[i]].join(';');
                }
            }
            console.log(result);
            layer.confirm('确定提交？', {icon: 3, title:'提示'}, function(index){
                layer.close(index);
                var index = layer.load(2);
                $.post(
                    "/office_automation/public/item",
                    result,
                    function (res) {
                        layer.close(index);
                        if (res.code == 0) {
                            layer.alert('提交成功！', {title: '提示'},
                                function (index) {
                                    layer.close(index);
                                    location.reload();
                                    // 打开新的窗口
                                    miniTab.openNewTabByIframe({
                                        href: "page/table/item-index.html",
                                        title: "工作表列表",
                                    });
                                }
                            );
                        } else {
                            layer.msg('提交失败！');
                        }
                    }
                );
                layer.close(index);
            });

            return false;
        });
    });
</script>
</body>
</html>